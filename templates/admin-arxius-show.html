{{ define "admin-arxius-show.html" }}
<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ t .Lang "archives.title" }} - {{ .Data.Arxiu.Nom }}</title>
    {{ template "styles-private" . }}
    <link rel="stylesheet" href="/static/css/persona.css">
    <link rel="stylesheet" href="/static/css/arxiu-pro.css">
</head>
<body>
    {{ template "header-private" . }}
    {{ template "menu" . }}
    <main class="contingut-principal arxiu-pro">
        <div id="arxiu-mark-state"
             data-arxiu-id="{{ .Data.Arxiu.ID }}"
             data-mark-type="{{ .Data.MarkType }}"
             data-mark-public="{{ if .Data.MarkPublic }}1{{ else }}0{{ end }}"
             data-mark-own="{{ if .Data.MarkOwn }}1{{ else }}0{{ end }}"
             data-csrf="{{ .Data.CSRFToken }}"
             hidden></div>
        {{ $manageBase := "/documentals/arxius" }}
        <section class="card arxiu-pro-hero">
            <div class="arxiu-pro-hero-top">
                <div class="arxiu-pro-title">
                    <div class="arxiu-pro-breadcrumbs">
                        <a href="{{ $manageBase }}" style="color:inherit;text-decoration:none;">
                            <i class="fas fa-archive"></i> {{ t .Lang "archives.title" }}
                        </a>
                        <span style="opacity:0.5;"> / </span>
                        <span>Perfil</span>
                    </div>

                    <h1 id="arxiuNom">{{ .Data.Arxiu.Nom }}</h1>
                    <div class="arxiu-pro-sub" id="arxiuSub">
                        {{ if .Data.EntitatNom }}{{ .Data.EntitatNom }}{{ else }}Informació de l'arxiu{{ end }}
                    </div>

                    <div class="arxiu-pro-chips">
                        <span class="badge {{ if eq .Data.Arxiu.ModeracioEstat "publicat" }}verd{{ else if eq .Data.Arxiu.ModeracioEstat "pendent" }}groc{{ else if .Data.Arxiu.ModeracioEstat }}gris{{ end }}" id="arxiuEstat">
                            {{ if .Data.Arxiu.ModeracioEstat }}{{ t .Lang (printf "activity.status.%s" .Data.Arxiu.ModeracioEstat) }}{{ else }}—{{ end }}
                        </span>
                        <span class="chip"><span class="muted">{{ t .Lang "archives.details.type" }}</span> <span id="chipTipus">{{ if .Data.ArxiuProData.Arxiu.Tipus }}{{ .Data.ArxiuProData.Arxiu.Tipus }}{{ else }}—{{ end }}</span></span>
                        <span class="chip"><span class="muted">{{ t .Lang "archives.details.access" }}</span> <span id="chipAcces">{{ if .Data.ArxiuProData.Arxiu.Acces }}{{ .Data.ArxiuProData.Arxiu.Acces }}{{ else }}—{{ end }}</span></span>
                        <span class="chip"><span class="muted">Cobertura</span> <span id="chipCobertura">—</span></span>
                    </div>
                </div>

                <div class="arxiu-pro-hero-actions">
                    <div class="opcions-dropdown">
                        <button class="boto-opcions" id="botoOpcions">
                            <i class="fas fa-cog"></i> {{ t .Lang "wiki.options.title" }} <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-opcions" id="dropdownOpcions">
                            <li><a href="/documentals/arxius/{{ .Data.Arxiu.ID }}/historial"><i class="fas fa-clock-rotate-left"></i> {{ t .Lang "wiki.options.history" }}</a></li>
                            <li><a href="/documentals/arxius/{{ .Data.Arxiu.ID }}/estadistiques"><i class="fas fa-chart-line"></i> {{ t .Lang "wiki.options.stats" }}</a></li>
                            <li><a href="#" class="btn-marcar" data-arxiu-id="{{ .Data.Arxiu.ID }}" onclick="event.preventDefault()"><i class="fas fa-eye"></i> {{ t .Lang "wiki.options.follow" }}</a></li>
                        </ul>
                    </div>
                    {{ if $.Data.CanEditArxiu }}
                    <a class="boto-secundari" href="{{ $manageBase }}/{{ .Data.Arxiu.ID }}/edit"><i class="fas fa-pen"></i> {{ t .Lang "archives.action.edit" }}</a>
                    {{ end }}
                    {{ if $.Data.CanCreateLlibre }}
                    <a class="boto-primari" href="/documentals/llibres/new?arxiu_id={{ .Data.Arxiu.ID }}&return_to=/documentals/arxius/{{ .Data.Arxiu.ID }}">
                        <i class="fas fa-plus"></i> {{ t .Lang "archives.books.add" }}
                    </a>
                    {{ end }}
                    {{ if $.Data.CanDeleteArxiu }}
                    <form method="post" action="{{ $manageBase }}/{{ .Data.Arxiu.ID }}/delete" style="display:inline;" onsubmit="return confirm('{{ t .Lang "archives.confirm.delete" }}');">
                        <button type="submit" class="boto-perill"><i class="fas fa-trash"></i> {{ t .Lang "archives.action.delete" }}</button>
                    </form>
                    {{ end }}
                </div>
            </div>

            <div class="arxiu-pro-kpis" aria-label="Resum">
                <div class="kpi">
                    <div class="label"><i class="fas fa-book"></i> Llibres</div>
                    <div class="value" id="kpiLlibres">—</div>
                    <div class="hint">Mostra per pàgines, municipis i categories</div>
                </div>
                <div class="kpi">
                    <div class="label"><i class="fas fa-map-marker-alt"></i> Municipis</div>
                    <div class="value" id="kpiMunicipis">—</div>
                    <div class="hint">Filtra i explora per poble</div>
                </div>
                <div class="kpi">
                    <div class="label"><i class="fas fa-file-alt"></i> Pàgines</div>
                    <div class="value" id="kpiPagines">—</div>
                    <div class="hint">Volum total aproximat</div>
                </div>
                <div class="kpi">
                    <div class="label"><i class="fas fa-calendar-alt"></i> Període</div>
                    <div class="value" id="kpiAnys">—</div>
                    <div class="hint">Any més antic i més recent</div>
                </div>
            </div>
        </section>

        <section class="arxiu-pro-grid">
            <aside class="arxiu-pro-sidebar">
                <section class="card">
                    <h3><i class="fas fa-id-card"></i> Fitxa</h3>
                    <ul class="meta-list">
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.type" }}</div><div class="v" id="metaTipus">{{ if .Data.ArxiuProData.Arxiu.Tipus }}{{ .Data.ArxiuProData.Arxiu.Tipus }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.access" }}</div><div class="v" id="metaAcces">{{ if .Data.ArxiuProData.Arxiu.Acces }}{{ .Data.ArxiuProData.Arxiu.Acces }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.entity" }}</div><div class="v" id="metaEntitat">{{ if .Data.EntitatNom }}{{ .Data.EntitatNom }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.municipi" }}</div><div class="v" id="metaMunicipi">{{ if .Data.MunicipiNom }}{{ .Data.MunicipiNom }}{{ else if .Data.Arxiu.MunicipiID.Valid }}#{{ .Data.Arxiu.MunicipiID.Int64 }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.address" }}</div><div class="v" id="metaAdreca">{{ if .Data.Arxiu.Adreca }}{{ .Data.Arxiu.Adreca }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.location" }}</div><div class="v" id="metaUbicacio">{{ if .Data.Arxiu.Ubicacio }}{{ .Data.Arxiu.Ubicacio }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.what3words" }}</div><div class="v" id="metaWhat3Words">{{ if .Data.Arxiu.What3Words }}{{ .Data.Arxiu.What3Words }}{{ else }}—{{ end }}</div></li>
                        <li class="meta-item"><div class="k">{{ t .Lang "archives.details.web" }}</div><div class="v" id="metaWeb">
                            {{ if .Data.Arxiu.Web }}<a href="{{ .Data.Arxiu.Web }}" target="_blank" rel="noopener">{{ .Data.Arxiu.Web }}</a>{{ else }}—{{ end }}
                        </div></li>
                    </ul>

                    <div class="meta-actions">
                        <a class="boto-secundari" href="/documentals/llibres?arxiu_id={{ .Data.Arxiu.ID }}"><i class="fas fa-list"></i> Veure llistat complet</a>
                    </div>
                </section>

                <section class="card">
                    <h3><i class="fas fa-sticky-note"></i> {{ t .Lang "archives.details.notes" }}</h3>
                    <div style="color:var(--color-text-clar);font-weight:700;font-size:0.9rem;margin-bottom:0.6rem;">
                        Comentaris interns / observacions (ràpides de consultar)
                    </div>
                    <div id="metaNotes" style="white-space:pre-wrap;">{{ if .Data.Arxiu.Notes }}{{ .Data.Arxiu.Notes }}{{ else }}—{{ end }}</div>
                </section>

                <section class="card donate-card" id="donateCard" {{ if not .Data.Arxiu.AcceptaDonacions }}style="display:none;"{{ end }}>
                    <div class="donate-top">
                        <div class="donate-icon" aria-hidden="true"><i class="fas fa-heart"></i></div>
                        <div>
                            <div class="donate-title">Ajuda a digitalitzar</div>
                            <div class="donate-sub">Aquest bisbat accepta donacions per impulsar la digitalització i publicar més llibres.</div>
                        </div>
                    </div>
                    <a class="donate-link" href="/documentals/arxius/{{ .Data.Arxiu.ID }}/donacions" target="_blank" rel="noopener">
                        Fer una donació <i class="fas fa-arrow-right"></i>
                    </a>
                </section>
                {{ if and .Data.CanManageArxius .Data.Arxiu.AcceptaDonacions }}
                <section class="card">
                    <h3><i class="fas fa-chart-line"></i> Donacions</h3>
                    <div style="color:var(--color-text-clar);font-weight:700;font-size:0.9rem;margin-bottom:0.6rem;">
                        Seguiment de clics
                    </div>
                    <div><strong>{{ .Data.DonacionsClicks }}</strong> clics totals</div>
                </section>
                {{ end }}
            </aside>

            <section class="tabs">
                <div class="tablist" role="tablist" aria-label="Seccions de l'arxiu">
                    <button class="tab" role="tab" aria-selected="true" data-tab="llibres"><i class="fas fa-book"></i> Llibres</button>
                    <button class="tab" role="tab" aria-selected="false" data-tab="municipis"><i class="fas fa-map-marker-alt"></i> Municipis</button>
                    <button class="tab" role="tab" aria-selected="false" data-tab="cobertura"><i class="fas fa-chart-bar"></i> Cobertura</button>
                </div>

                <div class="tabpanel active" id="tab-llibres" role="tabpanel">
                    <section class="card">
                        <div class="card-header" style="margin-bottom:0.65rem;">
                            <h2 style="font-size:1.2rem;"><i class="fas fa-filter"></i> Cerca i filtres</h2>
                            <div class="results-meta" id="booksMeta">
                                <span class="count">—</span>
                            </div>
                        </div>

                        <div class="filtres-pro">
                            <div class="fila">
                                <input id="q" type="text" placeholder="Cerca per títol, municipi, cronologia, signatura...">
                                <select id="filtreMunicipi" aria-label="Filtra per municipi"></select>
                                <select id="filtreTipus" aria-label="Filtra per categoria"></select>
                                <select id="filtreSort" aria-label="Ordenació">
                                    <option value="titol:asc">Títol (A→Z)</option>
                                    <option value="titol:desc">Títol (Z→A)</option>
                                    <option value="municipi:asc">Municipi (A→Z)</option>
                                    <option value="pagines:desc">Pàgines (desc)</option>
                                    <option value="cronologia:asc">Cronologia (asc)</option>
                                    <option value="cronologia:desc">Cronologia (desc)</option>
                                </select>
                            </div>

                            <div class="fila-actions">
                                <button class="boto-secundari" id="btnClear" type="button" disabled><i class="fas fa-eraser"></i> Neteja</button>
                                <button class="boto-primari" id="btnMore" type="button"><i class="fas fa-plus"></i> Carrega'n més</button>
                            </div>

                            <div class="active-filters" id="activeFilters"></div>
                        </div>
                    </section>

                    <section class="card">
                        <div class="taula-wrapper">
                            <table class="taula" aria-label="Llibres de l'arxiu" data-show-actions="{{ if .Data.ArxiuProData.ShowActions }}1{{ else }}0{{ end }}" data-label-edit="{{ t .Lang "archives.action.edit" }}" data-label-pages="{{ t .Lang "books.col.pages" }}" data-label-link="{{ t .Lang "archives.link" }}">
                                <thead>
                                    <tr>
                                        <th>{{ t .Lang "archives.books.col.title" }}</th>
                                        <th>Categoria</th>
                                        <th>{{ t .Lang "archives.books.col.chrono" }}</th>
                                        <th>{{ t .Lang "archives.books.col.municipi" }}</th>
                                        <th>{{ t .Lang "books.col.pages" }}</th>
                                        <th>{{ t .Lang "archives.books.col.signatura" }}</th>
                                        <th>{{ t .Lang "archives.books.col.url" }}</th>
                                        {{ if .Data.ArxiuProData.ShowActions }}<th>{{ t .Lang "archives.books.col.actions" }}</th>{{ end }}
                                    </tr>
                                </thead>
                                <tbody id="booksTableBody"></tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <div class="tabpanel" id="tab-municipis" role="tabpanel">
                    <section class="card">
                        <div class="card-header">
                            <h2 style="font-size:1.2rem;"><i class="fas fa-map-marker-alt"></i> Explora per municipi</h2>
                            <div style="color:var(--color-text-clar);font-weight:700;">Clica “Filtra” per veure'n els llibres</div>
                        </div>
                        <div class="muni-list" id="muniList"></div>
                    </section>
                </div>

                <div class="tabpanel" id="tab-cobertura" role="tabpanel">
                    <section class="card">
                        <div class="card-header">
                            <h2 style="font-size:1.2rem;"><i class="fas fa-chart-bar"></i> Cobertura i volum</h2>
                            <div style="color:var(--color-text-clar);font-weight:700;">Resum ràpid</div>
                        </div>

                        <div class="coverage-grid">
                            <div>
                                <h3 style="margin-bottom:0.6rem;color:var(--primary-color);">Distribució per segle</h3>
                                <div class="coverage-bars" id="coverageBars"></div>
                            </div>

                            <div>
                                <h3 style="margin-bottom:0.6rem;color:var(--primary-color);">Principals categories</h3>
                                <div class="coverage-type-wrap">
                                    <div class="coverage-type-list" id="coverageTypeList" aria-label="Cobertura per categoria"></div>
                                    <button class="btn-ghost btn-small" id="coverageTypeMore" type="button" aria-expanded="false">Mostra'n més</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>
        </section>
    </main>

    <div class="modal-overlay" id="modalMarcarArxiu" role="dialog" aria-modal="true">
        <div class="modal-box">
            <header class="modal-header">
                <h3>{{ t .Lang "wiki.mark.title" }}</h3>
                <button type="button" class="modal-close" data-modal-close="modalMarcarArxiu">×</button>
            </header>
            <div class="grup-camp">
                <label for="arxiu-mark-type">{{ t .Lang "wiki.mark.select" }}</label>
                <select id="arxiu-mark-type" class="input-text">
                    <option value="">{{ t .Lang "common.select" }}</option>
                    <option value="consanguini">{{ t .Lang "wiki.mark.consanguini" }}</option>
                    <option value="politic">{{ t .Lang "wiki.mark.politic" }}</option>
                    <option value="interes">{{ t .Lang "wiki.mark.interes" }}</option>
                </select>
            </div>
            <label class="checkbox-linia">
                <input type="checkbox" id="arxiu-mark-public" checked>
                <span>{{ t .Lang "wiki.mark.public" }}</span>
            </label>
            <div class="form-accio">
                <button type="button" class="boto-primari" id="arxiu-mark-save">{{ t .Lang "wiki.mark.save" }}</button>
                <button type="button" class="boto-secundari" id="arxiu-mark-clear">{{ t .Lang "wiki.mark.clear" }}</button>
            </div>
        </div>
    </div>
    {{ template "footer" . }}
    {{ template "scripts-private" . }}
    <script id="arxiuProData" type="application/json">{{ toJsonJS .Data.ArxiuProData }}</script>
    <script src="/static/js/arxiu-pro.js"></script>
    <script>
        (function () {
            const optionsBtn = document.getElementById("botoOpcions");
            const dropdown = document.getElementById("dropdownOpcions");
            if (optionsBtn && dropdown) {
                optionsBtn.addEventListener("click", function (event) {
                    event.preventDefault();
                    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                });
                document.addEventListener("click", function (event) {
                    if (!event.target.closest(".opcions-dropdown")) {
                        dropdown.style.display = "none";
                    }
                });
            }

            const markState = document.getElementById("arxiu-mark-state");
            const modal = document.getElementById("modalMarcarArxiu");
            const openBtn = document.querySelector(".btn-marcar");
            const closeBtns = document.querySelectorAll('[data-modal-close="modalMarcarArxiu"]');
            if (!markState || !modal) {
                return;
            }
            const markType = modal.querySelector("#arxiu-mark-type");
            const markPublic = modal.querySelector("#arxiu-mark-public");
            const markSave = modal.querySelector("#arxiu-mark-save");
            const markClear = modal.querySelector("#arxiu-mark-clear");
            const arxiuID = parseInt(markState.dataset.arxiuId || "0", 10);
            const csrfToken = markState.dataset.csrf || "";

            function openModal() {
                const existingType = markState.dataset.markType || "";
                const existingPublic = markState.dataset.markPublic !== "0";
                const own = markState.dataset.markOwn === "1";
                if (markType) {
                    markType.value = existingType;
                }
                if (markPublic) {
                    markPublic.checked = existingType ? existingPublic : true;
                }
                if (markClear) {
                    markClear.disabled = !own;
                }
                modal.classList.add("is-open");
            }

            function closeModal() {
                modal.classList.remove("is-open");
            }

            if (openBtn) {
                openBtn.addEventListener("click", function () {
                    if (!arxiuID) {
                        return;
                    }
                    openModal();
                });
            }
            closeBtns.forEach((btn) => {
                btn.addEventListener("click", closeModal);
            });

            if (markSave) {
                markSave.addEventListener("click", function () {
                    if (!arxiuID) {
                        return;
                    }
                    const typeValue = markType ? markType.value : "";
                    if (!typeValue) {
                        return;
                    }
                    const body = new URLSearchParams();
                    body.set("csrf_token", csrfToken);
                    body.set("type", typeValue);
                    body.set("public", markPublic && markPublic.checked ? "1" : "0");
                    fetch(`/documentals/arxius/${arxiuID}/marcar`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body.toString(),
                        credentials: "same-origin",
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("mark_failed");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data && data.ok) {
                                markState.dataset.markType = data.type || "";
                                markState.dataset.markPublic = data.is_public ? "1" : "0";
                                markState.dataset.markOwn = "1";
                                closeModal();
                            }
                        })
                        .catch(() => {});
                });
            }

            if (markClear) {
                markClear.addEventListener("click", function () {
                    if (!arxiuID) {
                        return;
                    }
                    if (markState.dataset.markOwn !== "1") {
                        closeModal();
                        return;
                    }
                    const body = new URLSearchParams();
                    body.set("csrf_token", csrfToken);
                    fetch(`/documentals/arxius/${arxiuID}/desmarcar`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body.toString(),
                        credentials: "same-origin",
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("mark_clear_failed");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data && data.ok) {
                                markState.dataset.markType = "";
                                markState.dataset.markPublic = "0";
                                markState.dataset.markOwn = "0";
                                closeModal();
                            }
                        })
                        .catch(() => {});
                });
            }
        })();
    </script>
</body>
</html>
{{ end }}
