{{ define "admin-llibres-registres-import.html" }}
<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ t .Lang "records.import.file" }}</title>
    {{ template "styles-private" . }}
    <link rel="stylesheet" href="/static/css/taula.css">
</head>
<body>
    {{ template "header-private" . }}
    {{ template "menu" . }}
    <main class="contingut-principal">
        <section class="card">
            <header class="card-header card-header-flex">
                <div>
                    <h1>{{ t .Lang "records.import.file" }}</h1>
                    <p class="muted">{{ if .Data.Llibre.Titol }}{{ .Data.Llibre.Titol }}{{ else }}{{ .Data.Llibre.NomEsglesia }}{{ end }}</p>
                </div>
                <div class="arxiu-header-actions">
                    <a class="boto-secundari" href="/documentals/llibres/{{ .Data.Llibre.ID }}/indexar">{{ t .Lang "records.show.back" }}</a>
                </div>
            </header>
            <div class="alert alert-error" id="import-error-banner" hidden>
                {{ t .Lang "records.import.progress.error" }}
            </div>

            <form class="filtres import-form" method="post" action="/documentals/llibres/{{ .Data.Llibre.ID }}/import" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ $.Data.CSRFToken }}">
                <div class="grup-camp">
                    <label for="import-model">{{ t .Lang "records.import.module" }}</label>
                    <select id="import-model" name="model">
                        <option value="generic">{{ t .Lang "records.import.model.generic" }}</option>
                        <option value="template">{{ t .Lang "records.import.model.template" }}</option>
                    </select>
                </div>
                <div class="grup-camp" data-template-field hidden>
                    <label for="import-template">{{ t .Lang "records.import.template" }}</label>
                    <select id="import-template" name="template_id">
                        {{ if .Data.ImportTemplates }}
                        <option value="">{{ t .Lang "records.import.template.placeholder" }}</option>
                        {{ range .Data.ImportTemplates }}
                        <option value="{{ .ID }}">{{ .Name }}</option>
                        {{ end }}
                        {{ else }}
                        <option value="">{{ t .Lang "records.import.template.none" }}</option>
                        {{ end }}
                    </select>
                </div>
                <div class="grup-camp">
                    <label for="import-file">{{ t .Lang "records.import.file" }}</label>
                    <input id="import-file" type="file" name="csv_file" accept=".csv" required>
                </div>
                <div class="grup-camp">
                    <label for="import-sep">{{ t .Lang "records.import.separator" }}</label>
                    <select id="import-sep" name="separator">
                        <option value="">{{ t .Lang "records.import.separator.default" }}</option>
                        <option value=",">,</option>
                        <option value=";">;</option>
                        <option value="|">|</option>
                        <option value="tab">{{ t .Lang "records.import.separator.tab" }}</option>
                    </select>
                </div>
                <button type="submit" class="boto-primari">{{ t .Lang "records.import.submit" }}</button>
            </form>
        </section>
    </main>
    <div class="modal-overlay import-overlay" id="import-overlay" role="dialog" aria-modal="true">
        <div class="modal-box import-box">
            <div class="modal-header">
                <div>
                    <h2>{{ t .Lang "records.import.progress.title" }}</h2>
                    <p class="muted" id="import-status">{{ t .Lang "records.import.progress.upload" }}</p>
                </div>
                <button type="button" class="modal-close" id="import-close" aria-label="{{ t .Lang "common.close" }}" hidden>×</button>
            </div>
            <div class="import-progress">
                <div class="import-progress-bar" id="import-progress-bar" style="width:0%"></div>
            </div>
            <p class="muted import-progress-meta" id="import-percent">0%</p>
            <div class="import-processing" id="import-processing" hidden>
                <span class="import-spinner" aria-hidden="true"></span>
                <div>
                    <p class="import-processing-title">{{ t .Lang "records.import.progress.working" }}</p>
                    <p class="muted" id="import-keep-open">{{ t .Lang "records.import.progress.keep_open" }}</p>
                </div>
            </div>
            <div class="import-complete" id="import-complete" hidden>
                <p class="import-processing-title">{{ t .Lang "records.import.progress.finalizing" }}</p>
                <p class="muted">{{ t .Lang "records.import.progress.redirecting" }}</p>
            </div>
            <div class="import-summary" id="import-summary" hidden>
                <p><strong>{{ t .Lang "records.import.result" }}:</strong> <span id="import-imported">0</span> · <strong>{{ t .Lang "records.import.updated" }}:</strong> <span id="import-updated">0</span> · <strong>{{ t .Lang "records.import.failed" }}:</strong> <span id="import-failed">0</span></p>
                <a href="#" class="boto-secundari btn-mini" id="import-errors-link" hidden>{{ t .Lang "records.import.errors.download" }}</a>
            </div>
        </div>
    </div>
    {{ template "footer" . }}
    {{ template "scripts-private" . }}
    <script>
        (function () {
            const form = document.querySelector('.import-form');
            const overlay = document.getElementById('import-overlay');
            const bar = document.getElementById('import-progress-bar');
            const percent = document.getElementById('import-percent');
            const status = document.getElementById('import-status');
            const progress = bar ? bar.closest('.import-progress') : null;
            const processing = document.getElementById('import-processing');
            const keepOpen = document.getElementById('import-keep-open');
            const doneBox = document.getElementById('import-complete');
            const summary = document.getElementById('import-summary');
            const importedOut = document.getElementById('import-imported');
            const failedOut = document.getElementById('import-failed');
            const updatedOut = document.getElementById('import-updated');
            const errorsLink = document.getElementById('import-errors-link');
            const closeBtn = document.getElementById('import-close');
            const errorBanner = document.getElementById('import-error-banner');
            const modelSelect = document.getElementById('import-model');
            const templateField = document.querySelector('[data-template-field]');
            const templateSelect = templateField ? templateField.querySelector('select') : null;
            const separatorSelect = document.getElementById('import-sep');
            let lastSeparator = separatorSelect ? separatorSelect.value : '';
            const titleUpload = {{ printf "%q" (t .Lang "records.import.progress.upload") }};
            const titleProcessing = {{ printf "%q" (t .Lang "records.import.progress.processing") }};
            const titleFinalizing = {{ printf "%q" (t .Lang "records.import.progress.finalizing") }};
            const titleError = {{ printf "%q" (t .Lang "records.import.progress.error") }};
            const msgKeepOpen = keepOpen ? keepOpen.textContent : titleProcessing;
            const originalTitle = document.title;
            if (!form || !overlay) return;

            const updateTemplateField = function () {
                if (!modelSelect || !templateField) return;
                const isTemplate = modelSelect.value === 'template';
                templateField.hidden = !isTemplate;
                if (templateSelect) {
                    templateSelect.required = isTemplate;
                    if (!isTemplate) {
                        templateSelect.value = '';
                    }
                }
                if (separatorSelect) {
                    if (isTemplate) {
                        if (separatorSelect.value !== '') {
                            lastSeparator = separatorSelect.value;
                        }
                        separatorSelect.value = '';
                    } else if (separatorSelect.value === '') {
                        if (lastSeparator) {
                            separatorSelect.value = lastSeparator;
                        } else {
                            const options = Array.from(separatorSelect.options || []);
                            const fallback = options.find((opt) => opt.value !== '');
                            if (fallback) {
                                separatorSelect.value = fallback.value;
                            }
                        }
                    }
                }
            };
            if (modelSelect) {
                modelSelect.addEventListener('change', updateTemplateField);
                updateTemplateField();
            }

            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                overlay.classList.add('is-open');
                if (progress) progress.classList.remove('is-processing');
                if (bar) bar.style.width = '0%';
                if (percent) percent.textContent = '0%';
                if (processing) processing.hidden = true;
                if (doneBox) doneBox.hidden = true;
                if (summary) summary.hidden = true;
                status.textContent = titleUpload;
                document.title = titleUpload;
                window.onbeforeunload = function () { return msgKeepOpen; };
                if (errorBanner) {
                    errorBanner.hidden = true;
                }
                if (closeBtn) {
                    closeBtn.hidden = true;
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', form.action, true);
                xhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        bar.style.width = pct + '%';
                        percent.textContent = pct + '%';
                    }
                });
                xhr.upload.addEventListener('load', function () {
                    if (progress) progress.classList.add('is-processing');
                    status.textContent = titleProcessing;
                    percent.textContent = '';
                    if (processing) {
                        processing.hidden = false;
                    }
                    if (doneBox) {
                        doneBox.hidden = true;
                    }
                    document.title = titleProcessing;
                });
                xhr.addEventListener('load', function () {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        const nextURL = xhr.responseURL || form.action;
                        const url = new URL(nextURL, window.location.origin);
                        const imported = url.searchParams.get('imported');
                        const failed = url.searchParams.get('failed');
                        const updated = url.searchParams.get('updated');
                        const token = url.searchParams.get('errors_token');
                        if (processing) {
                            processing.hidden = true;
                        }
                        if (progress) {
                            progress.classList.remove('is-processing');
                        }
                        if (doneBox) {
                            doneBox.hidden = false;
                        }
                        if (summary && importedOut && failedOut) {
                            importedOut.textContent = imported || '0';
                            failedOut.textContent = failed || '0';
                            if (updatedOut) {
                                updatedOut.textContent = updated || '0';
                            }
                            summary.hidden = false;
                        }
                        if (errorsLink) {
                            if (token) {
                                errorsLink.setAttribute('href', '/documentals/llibres/importar/errors?token=' + encodeURIComponent(token));
                                errorsLink.hidden = false;
                            } else {
                                errorsLink.hidden = true;
                            }
                        }
                        status.textContent = titleFinalizing;
                        document.title = titleFinalizing;
                        window.onbeforeunload = null;
                        window.location.assign(nextURL);
                        return;
                    }
                    if (progress) progress.classList.remove('is-processing');
                    if (processing) {
                        processing.hidden = true;
                    }
                    if (doneBox) {
                        doneBox.hidden = true;
                    }
                    if (summary) {
                        summary.hidden = true;
                    }
                    status.textContent = titleError;
                    document.title = titleError;
                    window.onbeforeunload = null;
                    if (closeBtn) {
                        closeBtn.hidden = false;
                    }
                    if (errorBanner) {
                        errorBanner.hidden = false;
                    }
                    if (submitBtn) submitBtn.disabled = false;
                });
                xhr.addEventListener('loadstart', function () {
                    if (progress) progress.classList.remove('is-processing');
                    status.textContent = titleUpload;
                    if (processing) {
                        processing.hidden = true;
                    }
                    if (summary) {
                        summary.hidden = true;
                    }
                    document.title = titleUpload;
                });
                xhr.addEventListener('error', function () {
                    if (progress) progress.classList.remove('is-processing');
                    if (processing) {
                        processing.hidden = true;
                    }
                    if (summary) {
                        summary.hidden = true;
                    }
                    status.textContent = titleError;
                    document.title = titleError;
                    window.onbeforeunload = null;
                    if (closeBtn) {
                        closeBtn.hidden = false;
                    }
                    if (errorBanner) {
                        errorBanner.hidden = false;
                    }
                    if (submitBtn) submitBtn.disabled = false;
                });
                xhr.addEventListener('loadend', function () {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        return;
                    }
                    document.title = originalTitle;
                });
                xhr.send(new FormData(form));
            });

            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    overlay.classList.remove('is-open');
                });
            }
        })();
    </script>
</body>
</html>
{{ end }}
