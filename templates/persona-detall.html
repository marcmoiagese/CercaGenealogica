{{ define "persona-detall.html" }}
<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ t .Lang "persons.title" }}</title>
    {{ template "styles-private" . }}
    <link rel="stylesheet" href="/static/css/persona.css">
    <link rel="stylesheet" href="/static/css/persona-pro.css">
</head>
<body>
    {{ template "header-private" . }}
    {{ template "menu" . }}
    <main class="contingut-principal container">
        <div id="persona-mark-state"
             data-persona-id="{{ .Data.Persona.ID }}"
             data-mark-type="{{ .Data.MarkType }}"
             data-mark-public="{{ if .Data.MarkPublic }}1{{ else }}0{{ end }}"
             data-mark-own="{{ if .Data.MarkOwn }}1{{ else }}0{{ end }}"
             data-csrf="{{ .Data.CSRFToken }}"
             hidden></div>
        {{ if .Data.WikiPending }}
        <div class="alert alert-success">{{ t .Lang "wiki.change.pending" }}</div>
        {{ end }}
        <section class="persona-hero card">
            <div class="persona-hero__left">
                <div class="persona-avatar" aria-label="{{ .Data.NomComplet }}">
                    <span class="persona-avatar__initials">{{ .Data.Initials }}</span>
                </div>
                <div class="persona-badges">
                    {{ if eq .Data.Persona.ModeracioEstat "publicat" }}
                    <span class="badge badge--info"><i class="fas fa-check-circle"></i> Fitxa verificada</span>
                    {{ else }}
                    <span class="badge"><i class="fas fa-hourglass-half"></i> Fitxa pendent</span>
                    {{ end }}
                    <span class="badge"><i class="fas fa-shield-alt"></i> Privacitat: pública</span>
                </div>
            </div>

            <div class="persona-hero__main">
                <div class="persona-hero__topline">
                    <h1 class="persona-nom">{{ .Data.NomComplet }}</h1>
                    {{ if .Data.User }}
                    <div class="opcions-dropdown">
                        <button class="boto-opcions" id="botoOpcions">
                            <i class="fas fa-cog"></i> {{ t .Lang "wiki.options.title" }} <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-opcions" id="dropdownOpcions">
                            {{ if .Data.CanEditPersona }}
                            <li><a href="/persones/{{ .Data.Persona.ID }}/edit"><i class="fas fa-pen"></i> Editar fitxa</a></li>
                            {{ end }}
                            <li><a href="/persones/{{ .Data.Persona.ID }}/registres"><i class="fas fa-list"></i> Veure registres</a></li>
                            <li><a href="/persones/{{ .Data.Persona.ID }}/arbre?view=pedigree&gens=3"><i class="fas fa-tree"></i> {{ t .Lang "tree.action.open" }}</a></li>
                            <li><a href="/persones/{{ .Data.Persona.ID }}/historial"><i class="fas fa-clock-rotate-left"></i> {{ t .Lang "wiki.options.history" }}</a></li>
                            <li><a href="/persones/{{ .Data.Persona.ID }}/estadistiques"><i class="fas fa-chart-line"></i> {{ t .Lang "wiki.options.stats" }}</a></li>
                            <li><a href="#" class="btn-marcar" data-persona-id="{{ .Data.Persona.ID }}" onclick="event.preventDefault()"><i class="fas fa-eye"></i> {{ t .Lang "wiki.options.follow" }}</a></li>
                        </ul>
                    </div>
                    {{ end }}
                </div>

                <p class="persona-subtitol">
                    {{ if .Data.BirthLocation }}
                    <span class="chip"><i class="fas fa-location-dot"></i> {{ .Data.BirthLocation }}</span>
                    {{ end }}
                    {{ if .Data.DeathLocation }}
                    <span class="chip"><i class="fas fa-skull-crossbones"></i> {{ .Data.DeathLocation }}</span>
                    {{ end }}
                    {{ if .Data.Persona.Ofici }}
                    <span class="chip"><i class="fas fa-briefcase"></i> {{ .Data.Persona.Ofici }}</span>
                    {{ end }}
                    {{ if .Data.LifeRange }}
                    <span class="chip"><i class="fas fa-calendar"></i> {{ .Data.LifeRange }}</span>
                    {{ end }}
                </p>

                <div class="persona-dates">
                    <div class="kpi">
                        <span class="kpi__label">Naixement</span>
                        <span class="kpi__value">{{ if .Data.BirthLabel }}{{ .Data.BirthLabel }}{{ else }}—{{ end }}</span>
                    </div>
                    <div class="kpi">
                        <span class="kpi__label">Defunció</span>
                        <span class="kpi__value">{{ if .Data.DeathLabel }}{{ .Data.DeathLabel }}{{ else }}—{{ end }}</span>
                    </div>
                    <div class="kpi">
                        <span class="kpi__label">Registre</span>
                        <span class="kpi__value mono">P-{{ printf "%06d" .Data.Persona.ID }}</span>
                    </div>
                </div>

                <div class="persona-hero__actions">
                    {{ if .Data.CanEditPersona }}
                    <a class="btn btn--primary" href="/persones/{{ .Data.Persona.ID }}/edit"><i class="fas fa-pen"></i> Editar fitxa</a>
                    {{ end }}
                    <a class="btn" href="/persones/{{ .Data.Persona.ID }}/registres"><i class="fas fa-folder-open"></i> Registres</a>
                    <a class="btn" href="/persones/{{ .Data.Persona.ID }}/arbre?view=pedigree&gens=3"><i class="fas fa-tree"></i> {{ t .Lang "tree.action.open" }}</a>
                    <a class="btn" href="/persones/{{ .Data.Persona.ID }}"><i class="fas fa-link"></i> Enllaç directe</a>
                </div>
            </div>

            <aside class="persona-hero__side">
                <div class="sidecard">
                    <div class="sidecard__title"><i class="fas fa-chart-pie"></i> Qualitat de dades</div>
                    <div class="sidecard__row">
                        <span class="muted">Completesa</span>
                        <span><strong>{{ .Data.Completesa }}%</strong></span>
                    </div>
                    <div class="progress">
                        <div class="progress__bar" style="width:{{ .Data.Completesa }}%"></div>
                    </div>
                    <div class="sidecard__row">
                        <span class="muted">Actualitzat</span>
                        <span>{{ if .Data.LastUpdated }}{{ .Data.LastUpdated }}{{ else }}—{{ end }}</span>
                    </div>
                    <div class="sidecard__row">
                        <span class="muted">Fonts</span>
                        <span><strong>{{ .Data.DocTotal }}</strong></span>
                    </div>
                </div>

                <div class="sidecard">
                    <div class="sidecard__title"><i class="fas fa-tags"></i> Etiquetes</div>
                    <div class="taglist">
                        {{ if .Data.BirthLocation }}
                        <span class="tag">{{ .Data.BirthLocation }}</span>
                        {{ else if .Data.OriginMunicipi }}
                        <span class="tag">{{ .Data.OriginMunicipi }}</span>
                        {{ end }}
                        {{ if and .Data.DeathLocation (ne .Data.DeathLocation .Data.BirthLocation) }}
                        <span class="tag">{{ .Data.DeathLocation }}</span>
                        {{ end }}
                        {{ if .Data.Persona.Ofici }}<span class="tag">{{ .Data.Persona.Ofici }}</span>{{ end }}
                        {{ if .Data.Persona.Llibre }}<span class="tag">{{ .Data.Persona.Llibre }}</span>{{ end }}
                        {{ if .Data.Persona.Pagina }}<span class="tag">p. {{ .Data.Persona.Pagina }}</span>{{ end }}
                        {{ if not (or .Data.BirthLocation .Data.OriginMunicipi .Data.Persona.Ofici) }}
                        <span class="tag">Sense etiquetes</span>
                        {{ end }}
                    </div>
                </div>
            </aside>
        </section>

        <nav class="persona-tabs" aria-label="Navegació de seccions">
            <button class="tab is-active" data-target="resum"><i class="fas fa-house"></i> Resum</button>
            <button class="tab" data-target="familia"><i class="fas fa-people-group"></i> Família</button>
            <button class="tab" data-target="vida"><i class="fas fa-timeline"></i> Vida</button>
            <button class="tab" data-target="documents"><i class="fas fa-folder-open"></i> Documents</button>
            <button class="tab" data-target="anecdotes"><i class="fas fa-comment-dots"></i> Anecdotari</button>
            <button class="tab" data-target="historia"><i class="fas fa-book"></i> Fitxa històrica</button>
        </nav>

        <section id="resum" class="persona-panel is-active">
            <div class="grid-2">
                <article class="card">
                    <div class="card__header">
                        <h3><i class="fas fa-id-card"></i> Dades clau</h3>
                        <span class="pill pill--ok"><i class="fas fa-check"></i> Publicada</span>
                    </div>

                    {{ $hasFacts := or (ne .Data.BirthDate "") (or (ne .Data.BaptismDate "") (ne .Data.DeathDate "")) }}
                    {{ if $hasFacts }}
                    <ul class="factlist">
                        {{ if .Data.BirthDate }}
                        <li class="fact">
                            <span class="fact__icon"><i class="fas fa-baby"></i></span>
                            <div class="fact__body">
                                <div class="fact__title">Naixement</div>
                        <div class="fact__meta">{{ .Data.BirthDate }}{{ if .Data.BirthLocation }} · {{ .Data.BirthLocation }}{{ end }}</div>
                            </div>
                        </li>
                        {{ end }}
                        {{ if .Data.BaptismDate }}
                        <li class="fact">
                            <span class="fact__icon"><i class="fas fa-water"></i></span>
                            <div class="fact__body">
                                <div class="fact__title">Baptisme</div>
                        <div class="fact__meta">{{ .Data.BaptismDate }}{{ if .Data.BirthLocation }} · {{ .Data.BirthLocation }}{{ end }}</div>
                            </div>
                        </li>
                        {{ end }}
                        {{ if .Data.DeathDate }}
                        <li class="fact">
                            <span class="fact__icon"><i class="fas fa-skull"></i></span>
                            <div class="fact__body">
                                <div class="fact__title">Defunció</div>
                        <div class="fact__meta">{{ .Data.DeathDate }}{{ if .Data.DeathLocation }} · {{ .Data.DeathLocation }}{{ end }}</div>
                            </div>
                        </li>
                        {{ end }}
                    </ul>
                    {{ else }}
                    <div class="callout callout--soft">
                        <div class="callout__title"><i class="fas fa-circle-info"></i> Sense dades clau</div>
                        <p class="muted">Encara no hi ha dates o fets destacats registrats.</p>
                    </div>
                    {{ end }}
                </article>

                <article class="card">
                    <div class="card__header">
                        <h3><i class="fas fa-align-left"></i> Resum biogràfic</h3>
                        <span class="pill"><i class="fas fa-circle-info"></i> En revisió</span>
                    </div>
                    <p class="lead muted">
                        Aquesta fitxa encara no disposa d’un resum biogràfic. Pots afegir context i fonts des de l’edició.
                    </p>
                    <div class="callout callout--soft">
                        <div class="callout__title"><i class="fas fa-triangle-exclamation"></i> Dades pendents</div>
                        <p class="muted">Falten detalls familiars, registres i context històric.</p>
                    </div>
                </article>
            </div>

            <article class="card">
                <div class="card__header">
                    <h3><i class="fas fa-map-pin"></i> Notes de residència</h3>
                    <span class="pill"><i class="fas fa-route"></i> Sense moviments</span>
                </div>
                {{ if or .Data.BirthLocation .Data.OriginMunicipi }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-location-dot"></i> Primer lloc conegut</div>
                    <p class="muted">
                        {{ if .Data.BirthLocation }}{{ .Data.BirthLocation }}{{ else }}{{ .Data.OriginMunicipi }}{{ end }}
                        {{ if .Data.OriginMunicipi }} <span class="tiny">(registre)</span>{{ end }}
                    </p>
                </div>
                {{ else }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-circle-info"></i> Sense dades</div>
                    <p class="muted">No hi ha moviments registrats encara.</p>
                </div>
                {{ end }}
            </article>
        </section>

        <section id="familia" class="persona-panel">
            <article class="card">
                <div class="card__header">
                    <h3><i class="fas fa-people-group"></i> Família</h3>
                    <span class="pill"><i class="fas fa-user-plus"></i> Del registre</span>
                </div>
                {{ if .Data.Relacions }}
                <div class="relacio-list">
                    {{ range .Data.Relacions }}
                    <div class="relacio-item">
                        <div class="relacio-top">
                            <div class="relacio-role">{{ if .RoleLabel }}{{ .RoleLabel }}{{ else }}Relació{{ end }}</div>
                            <div class="relacio-name">{{ .Name }}</div>
                        </div>
                        {{ if or .Municipi .Ofici }}
                        <div class="relacio-meta muted">
                            {{ if .Municipi }}{{ .Municipi }}{{ end }}{{ if and .Municipi .Ofici }} · {{ end }}{{ if .Ofici }}{{ .Ofici }}{{ end }}
                        </div>
                        {{ end }}
                        <div class="relacio-tags">
                            {{ if .Linked }}
                            <span class="badge badge--info"><i class="fas fa-link"></i> Enllaçat</span>
                            {{ else }}
                            <span class="badge badge--info"><i class="fas fa-link-slash"></i> Pendent d’enllaç</span>
                            {{ end }}
                            <span class="badge"><i class="fas fa-book"></i> Registre #{{ .RegistreID }}</span>
                        </div>
                    </div>
                    {{ end }}
                </div>
                {{ else }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-circle-info"></i> Sense relacions</div>
                    <p class="muted">Encara no hi ha familiars o testimonis associats al registre.</p>
                </div>
                {{ end }}
            </article>
        </section>

        <section id="vida" class="persona-panel">
            <article class="card">
                <div class="card__header">
                    <h3><i class="fas fa-timeline"></i> Timeline d’esdeveniments</h3>
                    <div class="filters" aria-label="Filtres del timeline">
                        <button class="filter is-active" data-filter="all">Tot</button>
                        <button class="filter" data-filter="naixement">Naixement</button>
                        <button class="filter" data-filter="sagrament">Sagraments</button>
                        <button class="filter" data-filter="matrimoni">Matrimonis</button>
                        <button class="filter" data-filter="residencia">Residència</button>
                        <button class="filter" data-filter="feina">Feina</button>
                        <button class="filter" data-filter="defuncio">Defunció</button>
                    </div>
                </div>

                {{ $hasTimeline := gt (len .Data.TimelineEvents) 0 }}
                {{ if $hasTimeline }}
                <ol class="timeline">
                    {{ range .Data.TimelineEvents }}
                    <li class="t-event" data-type="{{ if .FilterType }}{{ .FilterType }}{{ else }}{{ .Type }}{{ end }}">
                        <div class="t-dot"></div>
                        <div class="t-card">
                            <div class="t-top">
                                <span class="t-date">{{ .Date }}</span>
                                <span class="t-type"><i class="fas {{ .Icon }}"></i> {{ .Label }}</span>
                            </div>
                            <div class="t-title">{{ if .Title }}{{ .Title }}{{ else }}—{{ end }}</div>
                            <p class="muted">Dada del registre.</p>
                            {{ if .Source }}<div class="t-sources"><span class="muted">{{ .Source }}</span></div>{{ end }}
                        </div>
                    </li>
                    {{ end }}
                </ol>
                {{ else }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-circle-info"></i> Sense esdeveniments</div>
                    <p class="muted">Encara no hi ha dates registrades per construir el timeline.</p>
                </div>
                {{ end }}
            </article>
        </section>

        <section id="documents" class="persona-panel">
            <article class="card">
                <div class="card__header">
                    <h3><i class="fas fa-folder-open"></i> Documents relacionats</h3>
                    <div class="doc-toolbar">
                        <input class="doc-search" type="search" placeholder="Cerca per títol, llibre, any..." aria-label="Cerca documents">
                        <select class="doc-select" aria-label="Filtre de tipus">
                            <option value="all">Tots els tipus</option>
                            {{ range .Data.TipusOptions }}
                            <option value="{{ . }}">{{ t $.Lang (printf "records.type.%s" .) }}</option>
                            {{ end }}
                        </select>
                    </div>
                </div>

                {{ if .Data.DocRegistres }}
                <div class="doc-grid">
                    {{ range .Data.DocRegistres }}
                    <a class="doc-card" data-type="{{ .Tipus }}" href="/documentals/registres/{{ .ID }}">
                        <div class="doc-card__icon"><i class="fas fa-file-lines"></i></div>
                        <div class="doc-card__body">
                            <div class="doc-card__title">{{ t $.Lang (printf "records.type.%s" .Tipus) }}{{ if .Any }} ({{ .Any }}){{ end }}</div>
                            <div class="muted">{{ .Llibre }}{{ if .Pagina }} · p. {{ .Pagina }}{{ end }}</div>
                            <div class="doc-card__meta">
                                <span class="pill">{{ t $.Lang (printf "activity.status.%s" .Estat) }}</span>
                            </div>
                        </div>
                    </a>
                    {{ end }}
                </div>
                <div class="divider"></div>
                <a class="btn" href="/persones/{{ $.Data.Persona.ID }}/registres"><i class="fas fa-list"></i> Veure tots els registres</a>
                {{ else }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-circle-info"></i> Sense documents</div>
                    <p class="muted">No hi ha documents vinculats a aquesta persona.</p>
                </div>
                {{ end }}
            </article>
        </section>

        <section id="anecdotes" class="persona-panel">
            <article class="card">
                <div class="card__header">
                    <h3><i class="fas fa-comment-dots"></i> Anecdotari d’usuaris</h3>
                    <div class="anec-actions">
                        <a class="btn btn--primary" href="/persones/{{ .Data.Persona.ID }}/anecdotes/new"><i class="fas fa-plus"></i> Afegir anècdota</a>
                        <a class="btn" href="/persones/{{ .Data.Persona.ID }}#anecdotes"><i class="fas fa-filter"></i> Filtrar</a>
                    </div>
                </div>
                {{ if .Data.Anecdotes }}
                <div class="carousel" data-carousel>
                    <button class="carousel__btn carousel__btn--prev" data-carousel-prev aria-label="Anterior"><i class="fas fa-chevron-left"></i></button>
                    <button class="carousel__btn carousel__btn--next" data-carousel-next aria-label="Següent"><i class="fas fa-chevron-right"></i></button>
                    <div class="carousel__track" data-carousel-track>
                        {{ range $i, $a := .Data.Anecdotes }}
                            {{ if lt $i 3 }}
                            <div class="slide {{ if eq $i 0 }}is-active{{ end }}">
                                <div class="slide__meta">
                                    {{ if $a.Featured }}
                                        <span class="pill pill--ok"><i class="fas fa-star"></i> Destacada</span>
                                    {{ else if $a.Tag }}
                                        <span class="pill"><i class="fas fa-comment"></i> {{ $a.Tag }}</span>
                                    {{ end }}
                                    <span class="muted">Afegida per <strong>@{{ $a.User }}</strong>{{ if $a.Date }} · {{ $a.Date }}{{ end }}</span>
                                </div>
                                <h4 class="slide__title">“{{ $a.Title }}”</h4>
                                <p>{{ $a.Body }}</p>
                            </div>
                            {{ end }}
                        {{ end }}
                    </div>
                    <div class="carousel__dots" data-carousel-dots aria-label="Punts de navegació"></div>
                </div>
                <div class="divider"></div>
                <div class="stack">
                    {{ range .Data.Anecdotes }}
                    <div class="note">
                        <div class="note__head">
                            <strong>@{{ .User }}</strong>
                            {{ if .Date }}<span class="muted">· {{ .Date }}</span>{{ end }}
                            {{ if .Tag }}<span class="pill">{{ .Tag }}</span>{{ end }}
                            {{ if ne .Status "publicat" }}<span class="pill"><i class="fas fa-clock"></i> Pendent</span>{{ end }}
                        </div>
                        <p>“{{ .Title }}” — {{ .Body }}</p>
                    </div>
                    {{ end }}
                </div>
                {{ else }}
                <div class="callout callout--soft">
                    <div class="callout__title"><i class="fas fa-circle-info"></i> Sense anècdotes</div>
                    <p class="muted">Encara no hi ha anècdotes publicades per aquesta persona.</p>
                </div>
                {{ end }}
            </article>
        </section>

        <section id="historia" class="persona-panel">
            <div class="grid-2">
                <article class="card">
                    <div class="card__header">
                        <h3><i class="fas fa-book"></i> Informació històrica</h3>
                        <span class="pill"><i class="fas fa-scale-balanced"></i> En revisió</span>
                    </div>
                    <p class="muted">Encara no hi ha context històric publicat per aquesta fitxa.</p>
                </article>

                <article class="card">
                    <div class="card__header">
                        <h3><i class="fas fa-list-check"></i> Fitxa estructurada</h3>
                        <span class="pill"><i class="fas fa-link"></i> Relacionable</span>
                    </div>
                    <div class="kv">
                        <div class="kv__row"><div class="kv__k">Nom complet</div><div class="kv__v">{{ .Data.NomComplet }}</div></div>
                        <div class="kv__row"><div class="kv__k">Lloc de naixement</div><div class="kv__v">{{ if .Data.BirthLocation }}{{ .Data.BirthLocation }}{{ else if .Data.OriginMunicipi }}{{ .Data.OriginMunicipi }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Lloc de defunció</div><div class="kv__v">{{ if .Data.DeathLocation }}{{ .Data.DeathLocation }}{{ else if .Data.OriginDefuncio }}{{ .Data.OriginDefuncio }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Ocupació</div><div class="kv__v">{{ if .Data.Persona.Ofici }}{{ .Data.Persona.Ofici }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Llibre</div><div class="kv__v">{{ if .Data.Persona.Llibre }}{{ .Data.Persona.Llibre }}{{ else if .Data.OriginLlibre }}{{ .Data.OriginLlibre }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Pàgina</div><div class="kv__v">{{ if .Data.Persona.Pagina }}{{ .Data.Persona.Pagina }}{{ else if .Data.OriginPagina }}{{ .Data.OriginPagina }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Registre origen</div><div class="kv__v">{{ if .Data.OriginRegistreID }}#{{ .Data.OriginRegistreID }}{{ if .Data.OriginAny }} · {{ .Data.OriginAny }}{{ end }}{{ else }}—{{ end }}</div></div>
                        <div class="kv__row"><div class="kv__k">Registres</div><div class="kv__v">{{ .Data.DocTotal }}</div></div>
                    </div>
                </article>
            </div>
        </section>
        <div class="modal-overlay" id="modalMarcarPersona" role="dialog" aria-modal="true">
            <div class="modal-box">
                <header class="modal-header">
                    <h3>{{ t .Lang "wiki.mark.title" }}</h3>
                    <button type="button" class="modal-close" data-modal-close="modalMarcarPersona">×</button>
                </header>
                <div class="grup-camp">
                    <label for="persona-mark-type">{{ t .Lang "wiki.mark.select" }}</label>
                    <select id="persona-mark-type" class="input-text">
                        <option value="">{{ t .Lang "common.select" }}</option>
                        <option value="consanguini">{{ t .Lang "wiki.mark.consanguini" }}</option>
                        <option value="politic">{{ t .Lang "wiki.mark.politic" }}</option>
                        <option value="interes">{{ t .Lang "wiki.mark.interes" }}</option>
                    </select>
                </div>
                <label class="checkbox-linia">
                    <input type="checkbox" id="persona-mark-public" checked>
                    <span>{{ t .Lang "wiki.mark.public" }}</span>
                </label>
                <div class="form-accio">
                    <button type="button" class="boto-primari" id="persona-mark-save">{{ t .Lang "wiki.mark.save" }}</button>
                    <button type="button" class="boto-secundari" id="persona-mark-clear">{{ t .Lang "wiki.mark.clear" }}</button>
                </div>
            </div>
        </div>
    </main>
    {{ template "footer" . }}
    {{ template "scripts-private" . }}
    <script src="/static/js/persona.js"></script>
    <script src="/static/js/persona-pro.js"></script>
    <script>
        (function () {
            const markState = document.getElementById("persona-mark-state");
            const modal = document.getElementById("modalMarcarPersona");
            const openBtn = document.querySelector(".btn-marcar");
            const closeBtns = document.querySelectorAll('[data-modal-close="modalMarcarPersona"]');
            if (!markState || !modal) {
                return;
            }
            const markType = modal.querySelector("#persona-mark-type");
            const markPublic = modal.querySelector("#persona-mark-public");
            const markSave = modal.querySelector("#persona-mark-save");
            const markClear = modal.querySelector("#persona-mark-clear");
            const personaID = parseInt(markState.dataset.personaId || "0", 10);
            const csrfToken = markState.dataset.csrf || "";

            function openModal() {
                const existingType = markState.dataset.markType || "";
                const existingPublic = markState.dataset.markPublic !== "0";
                const own = markState.dataset.markOwn === "1";
                if (markType) {
                    markType.value = existingType;
                }
                if (markPublic) {
                    markPublic.checked = existingType ? existingPublic : true;
                }
                if (markClear) {
                    markClear.disabled = !own;
                }
                modal.classList.add("is-open");
            }

            function closeModal() {
                modal.classList.remove("is-open");
            }

            if (openBtn) {
                openBtn.addEventListener("click", function () {
                    if (!personaID) {
                        return;
                    }
                    openModal();
                });
            }
            closeBtns.forEach((btn) => {
                btn.addEventListener("click", closeModal);
            });

            if (markSave) {
                markSave.addEventListener("click", function () {
                    if (!personaID) {
                        return;
                    }
                    const typeValue = markType ? markType.value : "";
                    if (!typeValue) {
                        return;
                    }
                    const body = new URLSearchParams();
                    body.set("csrf_token", csrfToken);
                    body.set("type", typeValue);
                    body.set("public", markPublic && markPublic.checked ? "1" : "0");
                    fetch(`/persones/${personaID}/marcar`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body.toString(),
                        credentials: "same-origin",
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("mark_failed");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data && data.ok) {
                                markState.dataset.markType = data.type || "";
                                markState.dataset.markPublic = data.is_public ? "1" : "0";
                                markState.dataset.markOwn = "1";
                                closeModal();
                            }
                        })
                        .catch(() => {});
                });
            }

            if (markClear) {
                markClear.addEventListener("click", function () {
                    if (!personaID) {
                        return;
                    }
                    if (markState.dataset.markOwn !== "1") {
                        closeModal();
                        return;
                    }
                    const body = new URLSearchParams();
                    body.set("csrf_token", csrfToken);
                    fetch(`/persones/${personaID}/desmarcar`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: body.toString(),
                        credentials: "same-origin",
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("mark_clear_failed");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data && data.ok) {
                                markState.dataset.markType = "";
                                markState.dataset.markPublic = "0";
                                markState.dataset.markOwn = "0";
                                closeModal();
                            }
                        })
                        .catch(() => {});
                });
            }
        })();
    </script>
</body>
</html>
{{ end }}
