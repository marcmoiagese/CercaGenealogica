{{ define "event-show.html" }}
<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ .Data.Event.Titol }} · {{ t .Lang "events.title" }}</title>
    {{ if .UserLoggedIn }}
        {{ template "styles-private" . }}
    {{ else }}
        {{ template "styles-public" . }}
    {{ end }}
    <link rel="stylesheet" href="/static/css/events.css">
</head>
<body>
    {{ if .UserLoggedIn }}
        {{ template "header-private" . }}
        {{ template "menu" . }}
    {{ else }}
        {{ template "header-public" . }}
    {{ end }}
    <main class="contingut-principal events-page">
        {{ if .UserLoggedIn }}
        <div id="event-mark-state"
             data-event-id="{{ .Data.Event.ID }}"
             data-mark-type="{{ .Data.MarkType }}"
             data-mark-public="{{ if .Data.MarkPublic }}1{{ else }}0{{ end }}"
             data-mark-own="{{ if .Data.MarkOwn }}1{{ else }}0{{ end }}"
             data-csrf="{{ .Data.CSRFToken }}"
             hidden></div>
        {{ end }}
        {{ if .Data.WikiPending }}
        <div class="alert alert-success">{{ t .Lang "wiki.change.pending" }}</div>
        {{ end }}
        <section class="card event-hero">
            <header class="card-header card-header-flex">
                <div>
                    <h1>{{ .Data.Event.Titol }}</h1>
                    <p class="muted">
                        {{ .Data.EventType }}
                        {{ if .Data.EventDate }} · {{ .Data.EventDate }}{{ end }}
                    </p>
                    {{ if .Data.ShowStatus }}
                        <span class="event-status">{{ .Data.StatusLabel }}</span>
                    {{ end }}
                </div>
                <div class="events-actions">
                    {{ if .UserLoggedIn }}
                    <div class="opcions-dropdown">
                        <button class="boto-opcions" id="botoOpcions">
                            <i class="fas fa-cog"></i> {{ t .Lang "wiki.options.title" }} <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-opcions" id="dropdownOpcions">
                            <li><a href="/historia/events/{{ .Data.Event.ID }}/historial"><i class="fas fa-clock-rotate-left"></i> {{ t .Lang "wiki.options.history" }}</a></li>
                            <li><a href="/historia/events/{{ .Data.Event.ID }}/estadistiques"><i class="fas fa-chart-line"></i> {{ t .Lang "wiki.options.stats" }}</a></li>
                            <li><a href="#" class="btn-marcar" data-event-id="{{ .Data.Event.ID }}" onclick="event.preventDefault()"><i class="fas fa-eye"></i> {{ t .Lang "wiki.options.follow" }}</a></li>
                        </ul>
                    </div>
                    {{ end }}
                    <a class="boto-secundari" href="/historia/events">{{ t .Lang "common.back" }}</a>
                    {{ if .Data.CanEdit }}
                        <a class="boto-primari" href="{{ .Data.EditURL }}">{{ t .Lang "common.edit" }}</a>
                    {{ else if .Data.EditDisabled }}
                        <span class="muted">{{ t .Lang "events.edit.disabled" }}</span>
                    {{ end }}
                </div>
            </header>
        </section>

        <section class="card event-details">
            <header class="card-header">
                <h2>{{ t .Lang "events.detail.title" }}</h2>
            </header>
            {{ if .Data.Event.Resum }}
                <p class="event-summary">{{ .Data.Event.Resum }}</p>
            {{ end }}
            {{ if .Data.Event.Descripcio }}
                <div class="event-text">{{ .Data.Event.Descripcio }}</div>
            {{ else }}
                <p class="muted">{{ t .Lang "events.detail.empty" }}</p>
            {{ end }}
        </section>

        <section class="card event-impacts">
            <header class="card-header">
                <h2>{{ t .Lang "events.impacts.title" }}</h2>
            </header>
            {{ if .Data.Impacts }}
                <ul class="event-impact-list">
                    {{ range .Data.Impacts }}
                        <li class="event-impact-item">
                            <div>
                                <strong>{{ .ScopeLabel }}</strong>
                                <span class="event-impact-meta">{{ .ScopeTypeLabel }} · {{ .ImpactType }}</span>
                            </div>
                            <span class="event-impact-intensity">{{ t $.Lang "events.impacts.intensity" }} {{ .Intensitat }}/5</span>
                            {{ if .Notes }}
                                <p class="event-impact-notes">{{ .Notes }}</p>
                            {{ end }}
                        </li>
                    {{ end }}
                </ul>
            {{ else }}
                <p class="muted">{{ t .Lang "events.impacts.empty" }}</p>
            {{ end }}
        </section>

        <section class="card event-sources">
            <header class="card-header">
                <h2>{{ t .Lang "events.sources.title" }}</h2>
            </header>
            {{ if .Data.Event.Fonts }}
                <div class="event-text">{{ .Data.Event.Fonts }}</div>
            {{ else }}
                <p class="muted">{{ t .Lang "events.sources.empty" }}</p>
            {{ end }}
        </section>
    </main>
    {{ template "footer" . }}
    {{ if .UserLoggedIn }}
        {{ template "scripts-private" . }}
    {{ else }}
        {{ template "scripts-public" . }}
    {{ end }}
    {{ if .UserLoggedIn }}
    <div class="modal-overlay" id="modalMarcarEvent" role="dialog" aria-modal="true">
        <div class="modal-box">
            <header class="modal-header">
                <h3>{{ t .Lang "wiki.mark.title" }}</h3>
                <button type="button" class="modal-close" data-modal-close="modalMarcarEvent">×</button>
            </header>
            <div class="grup-camp">
                <label for="event-mark-type">{{ t .Lang "wiki.mark.select" }}</label>
                <select id="event-mark-type" class="input-text">
                    <option value="">{{ t .Lang "common.select" }}</option>
                    <option value="consanguini">{{ t .Lang "wiki.mark.consanguini" }}</option>
                    <option value="politic">{{ t .Lang "wiki.mark.politic" }}</option>
                    <option value="interes">{{ t .Lang "wiki.mark.interes" }}</option>
                </select>
            </div>
            <label class="checkbox-linia">
                <input type="checkbox" id="event-mark-public" checked>
                <span>{{ t .Lang "wiki.mark.public" }}</span>
            </label>
            <div class="form-accio">
                <button type="button" class="boto-primari" id="event-mark-save">{{ t .Lang "wiki.mark.save" }}</button>
                <button type="button" class="boto-secundari" id="event-mark-clear">{{ t .Lang "wiki.mark.clear" }}</button>
            </div>
        </div>
    </div>
    <script>
        (function () {
            const optionsBtn = document.getElementById("botoOpcions");
            const dropdown = document.getElementById("dropdownOpcions");
            if (optionsBtn && dropdown) {
                optionsBtn.addEventListener("click", function (event) {
                    event.preventDefault();
                    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                });
                document.addEventListener("click", function (event) {
                    if (!event.target.closest(".opcions-dropdown")) {
                        dropdown.style.display = "none";
                    }
                });
            }

            const markState = document.getElementById("event-mark-state");
            const modal = document.getElementById("modalMarcarEvent");
            const openBtn = document.querySelector(".btn-marcar");
            const closeBtns = document.querySelectorAll('[data-modal-close="modalMarcarEvent"]');
            if (!markState || !modal) {
                return;
            }
            const markType = modal.querySelector("#event-mark-type");
            const markPublic = modal.querySelector("#event-mark-public");
            const markSave = modal.querySelector("#event-mark-save");
            const markClear = modal.querySelector("#event-mark-clear");
            const eventID = parseInt(markState.dataset.eventId || "0", 10);
            const csrfToken = markState.dataset.csrf || "";

            function openModal() {
                const existingType = markState.dataset.markType || "";
                const existingPublic = markState.dataset.markPublic !== "0";
                const own = markState.dataset.markOwn === "1";
                if (markType) {
                    markType.value = existingType;
                }
                if (markPublic) {
                    markPublic.checked = existingType ? existingPublic : true;
                }
                if (markClear) {
                    markClear.disabled = !own;
                }
                modal.classList.add("active");
            }

            function closeModal() {
                modal.classList.remove("active");
            }

            if (openBtn) {
                openBtn.addEventListener("click", openModal);
            }
            closeBtns.forEach((btn) => {
                btn.addEventListener("click", closeModal);
            });
            modal.addEventListener("click", function (event) {
                if (event.target === modal) {
                    closeModal();
                }
            });

            if (markSave) {
                markSave.addEventListener("click", function () {
                    if (!eventID || !markType) {
                        return;
                    }
                    const typeValue = markType.value || "";
                    if (!typeValue) {
                        return;
                    }
                    const body = new URLSearchParams();
                    body.set("type", typeValue);
                    body.set("public", markPublic && markPublic.checked ? "1" : "0");
                    fetch(`/historia/events/${eventID}/marcar`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRF-Token": csrfToken,
                        },
                        body: body.toString(),
                    })
                        .then((resp) => resp.json())
                        .then((data) => {
                            if (!data || !data.ok) {
                                throw new Error("mark_failed");
                            }
                            markState.dataset.markType = data.type || "";
                            markState.dataset.markPublic = data.is_public ? "1" : "0";
                            markState.dataset.markOwn = "1";
                            closeModal();
                        })
                        .catch(() => {});
                });
            }
            if (markClear) {
                markClear.addEventListener("click", function () {
                    if (!eventID) {
                        return;
                    }
                    if (markState.dataset.markOwn !== "1") {
                        return;
                    }
                    fetch(`/historia/events/${eventID}/desmarcar`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRF-Token": csrfToken,
                        },
                        body: "",
                    })
                        .then((resp) => resp.json())
                        .then((data) => {
                            if (!data || !data.ok) {
                                throw new Error("mark_clear_failed");
                            }
                            markState.dataset.markType = "";
                            markState.dataset.markPublic = "0";
                            markState.dataset.markOwn = "0";
                            closeModal();
                        })
                        .catch(() => {});
                });
            }
        })();
    </script>
    {{ end }}
</body>
</html>
{{ end }}
