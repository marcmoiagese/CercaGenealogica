{{ define "admin-politiques-form.html" }}
<!DOCTYPE html>
<html lang="{{ .Lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ if .Data.IsNew }}{{ t .Lang "policies.new" }}{{ else }}{{ t .Lang "policies.edit" }}{{ end }}</title>
    {{ template "styles-private" . }}
    <style>
        .policy-tabs{display:flex;gap:10px;margin:0 0 8px 0;align-items:center}
        .policy-tabs .tab-boto{background:#f6f8fb;border:1px solid #dfe3ec;color:#1f2c4d;padding:8px 14px;border-radius:10px;transition:all .15s ease}
        .policy-tabs .tab-boto.actiu{background:#e9edfb;border-color:#bcc8f4;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6),0 2px 6px rgba(0,0,0,0.05);color:#1f2c4d}
        .policy-tab{display:none}
        .policy-tab.actiu{display:block}
        .llista-permisos{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
        .llista-permisos .checkbox-linia{position:relative;align-items:flex-start;padding:12px;border:1px solid #e2e6ef;border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.04);transition:all .15s ease;overflow:hidden;cursor:pointer}
        .llista-permisos .checkbox-linia.actiu{border-color:#b9c7f3;box-shadow:0 4px 12px rgba(71,102,190,0.15);background:#f1f4ff}
        .llista-permisos .checkbox-linia input{position:absolute;opacity:0;pointer-events:none}
        .llista-permisos .checkbox-linia span{font-weight:600;color:#1f2c4d}
        .permis-hint{margin-top:4px;font-size:12px;color:#6b7285;display:block}
        .perm-indicator{position:absolute;right:12px;top:14px;width:18px;height:18px;border-radius:999px;border:2px solid #cdd4e0;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);background:#f8fafc;transition:all .15s ease}
        .llista-permisos .checkbox-linia.actiu .perm-indicator{background:#6f86f6;border-color:#6f86f6;box-shadow:0 0 0 4px rgba(111,134,246,0.18) inset}
        .grup-camp input,.grup-camp textarea{width:100%}
        .grants-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
        .grants-card{border:1px solid #e2e6ef;border-radius:10px;background:#fff;padding:12px}
        .grants-card h3{margin:0 0 10px 0;font-size:14px;color:#1f2c4d}
        .grant-actions{display:flex;gap:6px;flex-wrap:wrap}
        .grant-scope-row.is-hidden{display:none}
        .grant-list .taula code{background:#f3f4f8;border-radius:6px;padding:2px 6px;font-size:12px}
        .grants-card .suggest-field{position:relative}
        .grants-card .resultats-cerca{max-height:220px;overflow:auto}
        @media (min-width: 900px){.grants-grid{grid-template-columns:minmax(260px,320px) 1fr;align-items:start}}
    </style>
</head>
<body>
    {{ template "header-private" . }}
    {{ template "menu" . }}
    <main class="contingut-principal">
        <section class="card">
            <header class="card-header">
                <h1>{{ if .Data.IsNew }}{{ t .Lang "policies.new" }}{{ else }}{{ t .Lang "policies.edit" }}{{ end }}</h1>
            </header>
            {{ if .Data.Error }}
            <div class="alert alert-error">{{ .Data.Error }}</div>
            {{ end }}
            <form method="POST" action="/admin/politiques/save" class="formulari-admin" id="policy-form">
                <input type="hidden" name="csrf_token" value="{{ .Data.CSRFToken }}">
                <input type="hidden" name="id" value="{{ .Data.Politica.ID }}">
                <input type="hidden" name="active_tab" id="policy-active-tab" value="{{ .Data.ActiveTab }}">
                <div class="grup-camp">
                    <label for="nom">{{ t .Lang "policies.name" }}</label>
                    <input type="text" id="nom" name="nom" value="{{ .Data.Politica.Nom }}" required>
                </div>
                <div class="grup-camp">
                    <label for="descripcio">{{ t .Lang "policies.desc" }}</label>
                    <input type="text" id="descripcio" name="descripcio" value="{{ .Data.Politica.Descripcio }}">
                </div>
                <div class="grup-camp">
                    <label>{{ t .Lang "policies.permissions" }}</label>
                    {{ $active := .Data.ActiveTab }}
                    <div class="policy-tabs">
                        <div class="tabs-botons" role="tablist">
                            <button type="button" class="tab-boto {{ if or (eq $active "") (eq $active "gui") }}actiu{{ end }}" data-target="tab-gui">{{ t .Lang "policies.tab.gui" }}</button>
                            <button type="button" class="tab-boto {{ if eq $active "json" }}actiu{{ end }}" data-target="tab-json">{{ t .Lang "policies.tab.json" }}</button>
                            <button type="button" class="tab-boto {{ if eq $active "grants" }}actiu{{ end }}" data-target="tab-grants">{{ t .Lang "policies.tab.grants" }}</button>
                        </div>
                    </div>
                    <p class="camp-helper">{{ t .Lang "policies.gui.helper" }}</p>
                    <div class="tabs-contingut">
                        <section class="policy-tab tab-pane {{ if or (eq $active "") (eq $active "gui") }}actiu{{ end }}" id="tab-gui">
                            <div class="llista-permisos">
                                {{ $perms := list "admin" "can_manage_users" "can_manage_territory" "can_manage_eclesiastic" "can_manage_archives" "can_create_person" "can_edit_any_person" "can_moderate" "can_manage_policies" }}
                                {{ range $perms }}
                                <label class="checkbox-linia perm-card" data-perm="{{ . }}">
                                    <input type="checkbox" id="perm-{{ . }}" data-perm="{{ . }}">
                                    <span>
                                        {{ t $.Lang (printf "policies.perm.%s" .) }}
                                        <small class="permis-hint">{{ t $.Lang (printf "policies.perm.desc.%s" .) }}</small>
                                    </span>
                                    <span class="perm-indicator" aria-hidden="true"></span>
                                </label>
                                {{ end }}
                            </div>
                            <div class="grup-camp" style="margin-top:16px">
                                <label for="perm-import-worker-limit">{{ t .Lang "policies.import_workers.label" }}</label>
                                <input type="number" id="perm-import-worker-limit" min="1" step="1" placeholder="1">
                                <small class="camp-helper">{{ t .Lang "policies.import_workers.help" }}</small>
                            </div>
                            <div style="margin-top:18px">
                                <h3 style="margin:0 0 6px 0">{{ t .Lang "policies.gui.modular.title" }}</h3>
                                <p class="camp-helper">{{ t .Lang "policies.gui.modular.helper" }}</p>
                                {{ range .Data.GuiGrantGroups }}
                                <div style="margin-top:14px">
                                    <h4 style="margin:0 0 8px 0;font-size:13px;color:#1f2c4d">{{ t $.Lang .TitleKey }}</h4>
                                    <div class="llista-permisos">
                                        {{ range .Keys }}
                                        <label class="checkbox-linia perm-grant-card {{ if index $.Data.GuiGrantState . }}actiu{{ end }}">
                                            <input type="checkbox" name="grant_global" value="{{ . }}" {{ if index $.Data.GuiGrantState . }}checked{{ end }}>
                                            <span>{{ t $.Lang (printf "policies.grants.perm.%s" .) }}</span>
                                            <span class="perm-indicator" aria-hidden="true"></span>
                                        </label>
                                        {{ end }}
                                    </div>
                                </div>
                                {{ end }}
                            </div>
                        </section>
                        <section class="policy-tab tab-pane {{ if eq $active "json" }}actiu{{ end }}" id="tab-json">
                            <textarea id="permisos" name="permisos" rows="10" placeholder='{"admin":true,...}'>{{ .Data.Politica.Permisos }}</textarea>
                            <small>{{ t .Lang "policies.permissions.help" }}</small>
                        </section>
                        <section class="policy-tab tab-pane {{ if eq $active "grants" }}actiu{{ end }}" id="tab-grants">
                            <p class="camp-helper">{{ t .Lang "policies.grants.helper" }}</p>
                            {{ if .Data.IsNew }}
                            <div class="camp-helper">{{ t .Lang "policies.grants.save_first" }}</div>
                            {{ else }}
                            {{ $grant := .Data.GrantForm }}
                            <div class="grants-grid">
                                <div class="grants-card">
                                    <div class="grup-camp">
                                        <label for="grant-perm-key">{{ t .Lang "policies.grants.perm_key" }}</label>
                                        <select id="grant-perm-key" name="perm_key" form="grant-form" required>
                                            <option value="">—</option>
                                            {{ range .Data.PermissionCatalog }}
                                            {{ $labelKey := printf "policies.grants.perm.%s" . }}
                                            {{ $label := t $.Lang $labelKey }}
                                            <option value="{{ . }}" {{ if and $grant (eq $grant.PermKey .) }}selected{{ end }}>{{ if eq $label $labelKey }}{{ . }}{{ else }}{{ $label }}{{ end }}</option>
                                            {{ end }}
                                        </select>
                                    </div>
                                    <div class="grup-camp">
                                        <label for="grant-scope-type-ui">{{ t .Lang "policies.grants.scope_type" }}</label>
                                        <select id="grant-scope-type-ui" name="scope_type_ui" form="grant-form" required>
                                            <option value="global" {{ if and $grant (eq $grant.ScopeType "global") }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.global" }}</option>
                                            <option value="pais" {{ if and $grant (eq $grant.ScopeType "pais") }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.pais" }}</option>
                                            <option value="nivell" {{ if and $grant (or (eq $grant.ScopeType "nivell") (eq $grant.ScopeType "provincia") (eq $grant.ScopeType "comarca") (eq $grant.ScopeType "municipi")) }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.nivell" }}</option>
                                            <option value="entitat_eclesiastica" {{ if and $grant (eq $grant.ScopeType "entitat_eclesiastica") }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.entitat_eclesiastica" }}</option>
                                            <option value="arxiu" {{ if and $grant (eq $grant.ScopeType "arxiu") }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.arxiu" }}</option>
                                            <option value="llibre" {{ if and $grant (eq $grant.ScopeType "llibre") }}selected{{ end }}>{{ t $.Lang "policies.grants.scope.llibre" }}</option>
                                        </select>
                                        <input type="hidden" id="grant-scope-type" name="scope_type" form="grant-form" value="{{ if $grant }}{{ $grant.ScopeType }}{{ else }}global{{ end }}">
                                    </div>
                                    <div class="grup-camp grant-scope-row" id="grant-scope-row">
                                        <label for="grant-scope-search" id="grant-scope-label">{{ t .Lang "policies.grants.scope_id" }}</label>
                                        <div class="suggest-field">
                                            <input
                                                type="text"
                                                id="grant-scope-search"
                                                value="{{ if $grant }}{{ if $grant.ScopeLabel }}{{ $grant.ScopeLabel }}{{ else if gt $grant.ScopeID 0 }}{{ $grant.ScopeID }}{{ end }}{{ end }}"
                                                placeholder="{{ t .Lang "policies.grants.search.placeholder.default" }}"
                                                autocomplete="off"
                                                data-api="/api/territori/paisos/suggest"
                                                data-api-pais="/api/territori/paisos/suggest"
                                                data-api-nivell="/api/territori/nivell-admin/suggest"
                                                data-api-entitat-eclesiastica="/api/territori/eclesiastic/suggest"
                                                data-api-arxiu="/api/documentals/arxius/suggest"
                                                data-api-llibre="/api/documentals/llibres/suggest"
                                                data-placeholder-pais="{{ t .Lang "policies.grants.search.placeholder.pais" }}"
                                                data-placeholder-nivell="{{ t .Lang "policies.grants.search.placeholder.nivell" }}"
                                                data-placeholder-entitat-eclesiastica="{{ t .Lang "policies.grants.search.placeholder.ecles" }}"
                                                data-placeholder-arxiu="{{ t .Lang "policies.grants.search.placeholder.arxiu" }}"
                                                data-placeholder-llibre="{{ t .Lang "policies.grants.search.placeholder.llibre" }}"
                                                data-hidden="grant-scope-id"
                                                data-hidden-type="grant-scope-type"
                                                data-suggestions="grant-scope-suggestions"
                                                data-empty-label="{{ t .Lang "common.empty" }}"
                                                data-suggest="1">
                                            <input type="hidden" id="grant-scope-id" name="scope_id" form="grant-form" value="{{ if and $grant (gt $grant.ScopeID 0) }}{{ $grant.ScopeID }}{{ end }}">
                                            <ul id="grant-scope-suggestions" class="resultats-cerca" role="listbox" aria-label="{{ t .Lang "common.suggestions" }}"></ul>
                                        </div>
                                        <small class="camp-helper">{{ t .Lang "policies.grants.scope_id.helper" }}</small>
                                    </div>
                                    <div class="grup-camp">
                                        <label class="checkbox">
                                            <input type="checkbox" id="grant-include-children" name="include_children" form="grant-form" value="1" {{ if and $grant $grant.IncludeChildren }}checked{{ end }}>
                                            {{ t .Lang "policies.grants.include_children" }}
                                        </label>
                                    </div>
                                    <div class="accions-formulari grant-actions">
                                        <button type="submit" class="boto-primari" form="grant-form" id="grant-submit" data-label-add="{{ t .Lang "policies.grants.add" }}" data-label-update="{{ t .Lang "policies.grants.update" }}">{{ t .Lang "policies.grants.add" }}</button>
                                        <button type="button" class="boto-secundari" id="grant-cancel" style="display:none">{{ t .Lang "policies.grants.cancel_edit" }}</button>
                                    </div>
                                </div>
                                <div class="grants-card grant-list">
                                    <h3>{{ t .Lang "policies.grants.list" }}</h3>
                                    <div class="taula-wrapper">
                                        <table class="taula">
                                            <thead>
                                                <tr>
                                                    <th>{{ t .Lang "policies.grants.perm_key" }}</th>
                                                    <th>{{ t .Lang "policies.grants.scope_type" }}</th>
                                                    <th>{{ t .Lang "policies.grants.scope_id" }}</th>
                                                    <th>{{ t .Lang "policies.grants.include_children" }}</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{ range .Data.Grants }}
                                                {{ $scopeLabel := index $.Data.ScopeLabels .ScopeType }}
                                                <tr>
                                                    {{ $permLabelKey := printf "policies.grants.perm.%s" .PermKey }}
                                                    {{ $permLabel := t $.Lang $permLabelKey }}
                                                    <td>
                                                        {{ if eq $permLabel $permLabelKey }}
                                                        <code>{{ .PermKey }}</code>
                                                        {{ else }}
                                                        <span title="{{ .PermKey }}">{{ $permLabel }}</span>
                                                        {{ end }}
                                                    </td>
                                                    <td>{{ if $scopeLabel }}{{ t $.Lang $scopeLabel }}{{ else }}{{ .ScopeType }}{{ end }}</td>
                                                    <td>
                                                        {{ if .ScopeIDValid }}
                                                        {{ if .ScopeLabel }}{{ .ScopeLabel }} <small class="muted">#{{ .ScopeID }}</small>{{ else }}{{ .ScopeID }}{{ end }}
                                                        {{ else }}—{{ end }}
                                                    </td>
                                                    <td>{{ if .IncludeChildren }}{{ t $.Lang "common.yes" }}{{ else }}{{ t $.Lang "common.no" }}{{ end }}</td>
                                                    <td>
                                                        <div class="grant-actions">
                                                            <button type="button" class="boto-secundari grant-edit" data-grant-id="{{ .ID }}" data-perm-key="{{ .PermKey }}" data-scope-type="{{ .ScopeType }}" data-scope-id="{{ if .ScopeIDValid }}{{ .ScopeID }}{{ end }}" data-scope-label="{{ .ScopeLabel }}" data-include-children="{{ if .IncludeChildren }}1{{ else }}0{{ end }}">{{ t $.Lang "common.edit" }}</button>
                                                            <button type="button" class="boto-secundari grant-delete" data-grant-id="{{ .ID }}">{{ t $.Lang "policies.grants.delete" }}</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {{ else }}
                                                <tr><td colspan="5">{{ t .Lang "policies.grants.empty" }}</td></tr>
                                                {{ end }}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {{ end }}
                        </section>
                    </div>
                </div>
                <div class="accions-formulari">
                    <button type="submit" class="boto-primari">{{ t .Lang "policies.form.save" }}</button>
                    <a href="/admin/politiques" class="boto-secundari">{{ t .Lang "policies.form.cancel" }}</a>
                </div>
            </form>
            {{ if not .Data.IsNew }}
            <form method="POST" action="/admin/politiques/grants/save" id="grant-form">
                <input type="hidden" name="csrf_token" value="{{ .Data.CSRFToken }}">
                <input type="hidden" name="politica_id" value="{{ .Data.Politica.ID }}">
                <input type="hidden" name="grant_id" id="grant-id" value="{{ with .Data.GrantForm }}{{ if gt .ID 0 }}{{ .ID }}{{ end }}{{ end }}">
            </form>
            <form method="POST" action="/admin/politiques/grants/delete" id="grant-delete-form">
                <input type="hidden" name="csrf_token" value="{{ .Data.CSRFToken }}">
                <input type="hidden" name="politica_id" value="{{ .Data.Politica.ID }}">
                <input type="hidden" name="grant_id" id="grant-delete-id" value="">
            </form>
            {{ end }}
        </section>
    </main>
    {{ template "footer" . }}
    {{ template "scripts-private" . }}
    <script src="/static/js/arxiu-form-suggest.js"></script>
    <script>
    (() => {
        const permKeys = ["admin","can_manage_users","can_manage_territory","can_manage_eclesiastic","can_manage_archives","can_create_person","can_edit_any_person","can_moderate","can_manage_policies"];
        const textarea = document.getElementById('permisos');
        const workerInput = document.getElementById('perm-import-worker-limit');
        const workerKey = "import_worker_limit";
        const activeTabInput = document.getElementById('policy-active-tab');
        const parsePerms = () => {
            try {
                const parsed = JSON.parse(textarea.value || '{}');
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) { return {}; }
        };
        const syncChecks = (perms) => {
            permKeys.forEach(k => {
                const cb = document.getElementById(`perm-${k}`);
                const card = document.querySelector(`.perm-card[data-perm="${k}"]`);
                if(cb){
                    const val = !!perms[k];
                    cb.checked = val;
                    if(card){ card.classList.toggle('actiu', val); }
                }
            });
            if(workerInput){
                const val = Number(perms[workerKey] || 0);
                workerInput.value = val > 0 ? String(val) : '';
            }
        };
        const syncJSON = () => {
            const obj = parsePerms();
            permKeys.forEach(k => {
                const cb = document.getElementById(`perm-${k}`);
                const card = document.querySelector(`.perm-card[data-perm="${k}"]`);
                if(cb && cb.checked) obj[k] = true;
                if(cb && !cb.checked && obj && Object.prototype.hasOwnProperty.call(obj, k)) delete obj[k];
                if(card) card.classList.toggle('actiu', cb && cb.checked);
            });
            if(workerInput){
                const val = parseInt(workerInput.value, 10);
                if(Number.isFinite(val) && val > 0) {
                    obj[workerKey] = val;
                } else if (obj && Object.prototype.hasOwnProperty.call(obj, workerKey)) {
                    delete obj[workerKey];
                }
            }
            textarea.value = JSON.stringify(obj, null, 2);
        };
        // init
        syncChecks(parsePerms());
        permKeys.forEach(k => {
            const cb = document.getElementById(`perm-${k}`);
            if(cb) cb.addEventListener('change', syncJSON);
        });
        if(workerInput){
            workerInput.addEventListener('input', syncJSON);
        }
        document.querySelectorAll('.perm-grant-card input[type="checkbox"]').forEach((cb) => {
            const card = cb.closest('.perm-grant-card');
            if(!card) return;
            const toggle = () => card.classList.toggle('actiu', cb.checked);
            cb.addEventListener('change', toggle);
            toggle();
        });
        // tabs
        document.querySelectorAll('.policy-tabs .tab-boto').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.policy-tabs .tab-boto').forEach(b=>b.classList.remove('actiu'));
                document.querySelectorAll('.policy-tab').forEach(t=>t.classList.remove('actiu'));
                btn.classList.add('actiu');
                const target = document.getElementById(btn.dataset.target);
                if(target) target.classList.add('actiu');
                if(activeTabInput){
                    if(btn.dataset.target === 'tab-json') activeTabInput.value = 'json';
                    else if(btn.dataset.target === 'tab-grants') activeTabInput.value = 'grants';
                    else activeTabInput.value = 'gui';
                }
                if(btn.dataset.target === 'tab-json') {
                    syncJSON();
                } else if(btn.dataset.target === 'tab-gui') {
                    syncChecks(parsePerms());
                }
            });
        });
        const policyForm = document.getElementById('policy-form');
        if(policyForm) policyForm.addEventListener('submit', () => {
            if(activeTabInput && activeTabInput.value !== 'gui') return;
            syncJSON();
        });

        const grantForm = document.getElementById('grant-form');
        if(grantForm){
            const grantId = document.getElementById('grant-id');
            const grantPerm = document.getElementById('grant-perm-key');
            const grantScopeTypeUI = document.getElementById('grant-scope-type-ui');
            const grantScopeType = document.getElementById('grant-scope-type');
            const grantScopeId = document.getElementById('grant-scope-id');
            const grantScopeSearch = document.getElementById('grant-scope-search');
            const grantScopeRow = document.getElementById('grant-scope-row');
            const grantInclude = document.getElementById('grant-include-children');
            const grantSubmit = document.getElementById('grant-submit');
            const grantCancel = document.getElementById('grant-cancel');
            const deleteForm = document.getElementById('grant-delete-form');
            const deleteId = document.getElementById('grant-delete-id');
            const labelAdd = grantSubmit ? (grantSubmit.dataset.labelAdd || grantSubmit.textContent) : '';
            const labelUpdate = grantSubmit ? (grantSubmit.dataset.labelUpdate || grantSubmit.textContent) : '';
            let lastScopeType = grantScopeTypeUI ? grantScopeTypeUI.value : 'global';

            const normalizeScopeTypeForUI = (value) => {
                const raw = (value || '').toLowerCase();
                if (raw === 'provincia' || raw === 'comarca' || raw === 'municipi' || raw === 'nivell') {
                    return 'nivell';
                }
                return raw || 'global';
            };

            const scopeApis = grantScopeSearch ? {
                global: '',
                pais: grantScopeSearch.dataset.apiPais || '',
                nivell: grantScopeSearch.dataset.apiNivell || '',
                entitat_eclesiastica: grantScopeSearch.dataset.apiEntitatEclesiastica || '',
                arxiu: grantScopeSearch.dataset.apiArxiu || '',
                llibre: grantScopeSearch.dataset.apiLlibre || ''
            } : {};
            const scopePlaceholders = grantScopeSearch ? {
                global: '',
                pais: grantScopeSearch.dataset.placeholderPais || '',
                nivell: grantScopeSearch.dataset.placeholderNivell || '',
                entitat_eclesiastica: grantScopeSearch.dataset.placeholderEntitatEclesiastica || '',
                arxiu: grantScopeSearch.dataset.placeholderArxiu || '',
                llibre: grantScopeSearch.dataset.placeholderLlibre || ''
            } : {};

            const updateScopeVisibility = () => {
                if(!grantScopeTypeUI || !grantScopeRow || !grantScopeId) return;
                const isGlobal = grantScopeTypeUI.value === 'global';
                grantScopeRow.classList.toggle('is-hidden', isGlobal);
                grantScopeId.disabled = isGlobal;
                if(grantInclude) grantInclude.disabled = isGlobal;
                if(grantScopeSearch){
                    grantScopeSearch.disabled = isGlobal;
                    grantScopeSearch.dataset.api = scopeApis[grantScopeTypeUI.value] || '';
                    grantScopeSearch.placeholder = scopePlaceholders[grantScopeTypeUI.value] || '';
                }
            };

            const initialState = {
                id: grantId ? grantId.value : '',
                permKey: grantPerm ? grantPerm.value : '',
                scopeType: grantScopeType ? grantScopeType.value : (grantScopeTypeUI ? grantScopeTypeUI.value : 'global'),
                scopeId: grantScopeId ? grantScopeId.value : '',
                scopeLabel: grantScopeSearch ? grantScopeSearch.value : '',
                includeChildren: grantInclude ? grantInclude.checked : false
            };

            const setGrantState = (state) => {
                const scopeTypeActual = state.scopeType || 'global';
                const scopeTypeUI = normalizeScopeTypeForUI(scopeTypeActual);
                if(grantId) grantId.value = state.id || '';
                if(grantPerm) grantPerm.value = state.permKey || '';
                if(grantScopeTypeUI) grantScopeTypeUI.value = scopeTypeUI;
                if(grantScopeType) grantScopeType.value = scopeTypeActual;
                if(grantScopeId) grantScopeId.value = state.scopeId || '';
                if(grantScopeSearch) grantScopeSearch.value = state.scopeLabel || state.scopeId || '';
                if(grantInclude) grantInclude.checked = !!state.includeChildren;
                updateScopeVisibility();
                if(grantSubmit) grantSubmit.textContent = state.id ? labelUpdate : labelAdd;
                if(grantCancel) grantCancel.style.display = state.id ? 'inline-flex' : 'none';
            };

            setGrantState(initialState);
            lastScopeType = grantScopeTypeUI ? grantScopeTypeUI.value : 'global';
            if(grantScopeTypeUI) grantScopeTypeUI.addEventListener('change', () => {
                if(lastScopeType !== grantScopeTypeUI.value){
                    if(grantScopeId) grantScopeId.value = '';
                    if(grantScopeSearch) grantScopeSearch.value = '';
                }
                if(grantScopeType) {
                    grantScopeType.value = grantScopeTypeUI.value === 'nivell' ? 'nivell' : grantScopeTypeUI.value;
                }
                lastScopeType = grantScopeTypeUI.value;
                updateScopeVisibility();
            });
            if(grantCancel) grantCancel.addEventListener('click', () => setGrantState(initialState));

            document.querySelectorAll('.grant-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    setGrantState({
                        id: btn.dataset.grantId || '',
                        permKey: btn.dataset.permKey || '',
                        scopeType: btn.dataset.scopeType || 'global',
                        scopeId: btn.dataset.scopeId || '',
                        scopeLabel: btn.dataset.scopeLabel || '',
                        includeChildren: btn.dataset.includeChildren === '1'
                    });
                });
            });

            document.querySelectorAll('.grant-delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(!deleteForm || !deleteId) return;
                    deleteId.value = btn.dataset.grantId || '';
                    if(deleteForm.requestSubmit) deleteForm.requestSubmit();
                    else deleteForm.submit();
                });
            });
        }
    })();
    </script>
</body>
</html>
{{ end }}
