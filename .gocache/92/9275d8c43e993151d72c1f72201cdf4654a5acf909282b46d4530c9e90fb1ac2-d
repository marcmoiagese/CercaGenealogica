//line /home/marc/codi/CercaGenealogica3/core/usuaris.go:1:1
package core

import (
	"crypto/rand"
	"encoding/json"
	"fmt"
	"math/big"
	"net/http"
	"net/mail"
	"net/url"
	"os"
	"strings"
	"time"

	"github.com/marcmoiagese/CercaGenealogica/db"
	"golang.org/x/crypto/bcrypt"
)

type Usuari struct {
	ID            int
	Usuari        string // Nou camp per al nom d'usuari
	Nom           string
	Cognoms       string
	Correu        string
	Contrasenya   []byte // Hashed password
	DataNaixament time.Time
	Pais          string
	Estat         string
	Provincia     string
	Poblacio      string
	CodiPostal    string
	DataCreacio   time.Time
	Actiu         bool
}

type IndexPageData struct {
	CSRFToken string
	Error     string
}

type RegistrePageData struct {
	CSRFToken string
	Error     string
}

type RegenerarTokenPageData struct {
	CSRFToken string
	Error     string
	Success   string
}

type RecuperarResultPageData struct {
	CSRFToken string
	Error     string
	Success   string
}

type UpdateProfileResponse struct {
	Success string
	Error   string
}

type ActivacioPageData struct {
	CSRFToken string
	Activat   bool
}

type AvailabilityResponse struct {
	UsernameTaken bool `json:"usernameTaken"`
	EmailTaken    bool `json:"emailTaken"`
}

// ToDBUser – Converteix core.Usuari en db.User
func (u *Usuari) ToDBUser(passwordHash []byte) *db.User {goCover_33ba7a78e32c__97[0] = 1 ; goCover_33ba7a78e32c__97[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__97[2] = 97 ; goCover_33ba7a78e32c__97[3]++;
	return &db.User{
		Usuari:        u.Usuari,
		Name:          u.Nom,
		Surname:       u.Cognoms,
		Email:         u.Correu,
		Password:      passwordHash,
		DataNaixament: u.DataNaixament.Format("2006-01-02"),
		Pais:          u.Pais,
		Estat:         u.Estat,
		Provincia:     u.Provincia,
		Poblacio:      u.Poblacio,
		CodiPostal:    u.CodiPostal,
		Address:       "",
		Employment:    "",
		Profession:    "",
		Phone:         "",
		PreferredLang: "",
		SpokenLangs:   "",
		Active:        u.Actiu,
	}
}

func (a *App) RegistrarUsuari(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__98[0] = 25 ; goCover_33ba7a78e32c__98[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__98[2] = 98 ; goCover_33ba7a78e32c__98[3]++;
	ipStr := getIP(r)
	Infof("Iniciant registre d'usuari des de: %s", ipStr)
	lang := ResolveLang(r)

	// Validar CSRF
	if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__98[15]++;
		Errorf("Token CSRF invàlid o inexistent en registre")
		http.Error(w, "Error: accés no autoritzat", http.StatusForbidden)
		return
	}

	// Captura els camps del formulari
	goCover_33ba7a78e32c__98[4]++;r.ParseForm()
	nom := r.FormValue("nom")
	cognoms := r.FormValue("cognoms")
	email := r.FormValue("email")
	password := r.FormValue("contrassenya")
	confirmPassword := r.FormValue("confirmar_contrasenya")
	captcha := r.FormValue("captcha")
	csrf := r.FormValue("csrf_token")
	usuariForm := r.FormValue("usuari")
	acceptaCondicions := r.FormValue("accepta_condicions")

	// Logs per debugar
	Debugf("=== DEBUG REGISTRE ===")
	Debugf("Nom: '%s'", nom)
	Debugf("Cognoms: '%s'", cognoms)
	Debugf("Email: '%s'", email)
	Debugf("Contrasenya: '[oculta]'")
	Debugf("Confirmar contrasenya: '[oculta]'")
	Debugf("CAPTCHA: '%s'", captcha)
	Debugf("CSRF: '%s'", csrf)
	Debugf("Usuari: '%s'", usuariForm)
	Debugf("Accepta condicions: '%s'", acceptaCondicions)
	Debugf("======================")
	Debugf("Valor rebut per a usuari: %s", usuariForm)
	Debugf("Dades rebudes: nom=%s, cognoms=%s, email=%s", nom, cognoms, email)

	// Valida el token CSRF
	// (validat a l'inici amb validateCSRF)

	// Valida que s'acceptin les condicions d'ús
	if acceptaCondicions != "on" {goCover_33ba7a78e32c__98[16]++;
		Errorf("Error: no s'han acceptat les condicions d'ús")
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.accept.terms"),
		})
		return
	}

	// Valida format de correu electrònic
	goCover_33ba7a78e32c__98[5]++;if _, err := mail.ParseAddress(email); err != nil {goCover_33ba7a78e32c__98[17]++;
		Errorf("Error: correu electrònic invàlid: %s", email)
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.email.invalid"),
		})
		return
	}

	// Validacions bàsiques
	goCover_33ba7a78e32c__98[6]++;if password != confirmPassword {goCover_33ba7a78e32c__98[18]++;
		Errorf("Error: les contrasenyes no coincideixen")
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.password.mismatch"),
		})
		return
	}
	goCover_33ba7a78e32c__98[7]++;if captcha != "8" {goCover_33ba7a78e32c__98[19]++;
		Errorf("Error: CAPTCHA invàlid")
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.captcha.invalid"),
		})
		return
	}

	// Comprova duplicats
	goCover_33ba7a78e32c__98[8]++;if exists, err := a.DB.ExistsUserByUsername(usuariForm); err == nil && exists {goCover_33ba7a78e32c__98[20]++;
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.user.exists"),
		})
		return
	}
	goCover_33ba7a78e32c__98[9]++;if exists, err := a.DB.ExistsUserByEmail(email); err == nil && exists {goCover_33ba7a78e32c__98[21]++;
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.email.exists"),
		})
		return
	}

	// Genera hash de la contrasenya
	goCover_33ba7a78e32c__98[10]++;hash, err := generateHash(password)
	if err != nil {goCover_33ba7a78e32c__98[22]++;
		Errorf("Error generant hash: %v", err)
		http.Error(w, "Error intern", http.StatusInternalServerError)
		return
	}

	goCover_33ba7a78e32c__98[11]++;user := &Usuari{
		Usuari:        usuariForm,
		Nom:           nom,
		Cognoms:       cognoms,
		Correu:        email,
		Contrasenya:   hash,
		DataNaixament: ParseDate(r.FormValue("data_naixament")),
		DataCreacio:   time.Now(),
		Actiu:         false,
	}

	dbUser := user.ToDBUser(hash)
	Debugf("Convertint usuari: %+v", dbUser)

	err = a.DB.InsertUser(dbUser)
	if err != nil {goCover_33ba7a78e32c__98[23]++;
		Errorf("ERROR SQL: %v", err)
		RenderTemplate(w, r, "registre-incorrecte.html", RegistrePageData{
			Error: T(lang, "error.user.create"),
		})
		return
	}

	goCover_33ba7a78e32c__98[12]++;Debugf(" IP de la petició: %s", ipStr)

	Infof("Usuari creat correctament: %s", email)

	// Crea configuració de privacitat per defecte
	if createdUser, err := a.DB.GetUserByEmail(email); err == nil && createdUser != nil {goCover_33ba7a78e32c__98[24]++;
		if err := a.DB.CreatePrivacyDefaults(createdUser.ID); err != nil {goCover_33ba7a78e32c__98[25]++;
			Errorf("No s'ha pogut crear privacitat per defecte per a %s: %v", email, err)
		}
	}

	// Envia token d'activació
	goCover_33ba7a78e32c__98[13]++;token := generateToken(32)
	Debugf("Generat token d'activació: %s", token)
	Debugf("Intentant guardar token per a %s", email)
	err = a.DB.SaveActivationToken(email, token)
	if err != nil {goCover_33ba7a78e32c__98[26]++;
		Errorf("Error guardant token: %v", err)
		http.Error(w, "Error intern", http.StatusInternalServerError)
		return
	} else{ goCover_33ba7a78e32c__98[27]++;{
		Debugf("Token i expira_token guardats correctament per a %s", email)
	}}

	goCover_33ba7a78e32c__98[14]++;Debugf("Token d'activació per a %s: %s", email, token)
	Debugf("URL d'activació: http://localhost:8080/activar?token=%s", token)

	// Opcional: envia correu d'activació
	a.sendActivationEmail(email, token, lang, "email.activation")

	// Renderitza la pantalla de confirmació
	RenderTemplate(w, r, "registre-correcte.html", RegistrePageData{
		CSRFToken: "",
		Error:     "",
	})
}

//func isValidCSRF(token string) bool {
// Aquí pots fer servir un sistema real de tokens temporals
//return token == "token-segon"
//}

func generateHash(password string) ([]byte, error) {goCover_33ba7a78e32c__99[0] = 1 ; goCover_33ba7a78e32c__99[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__99[2] = 99 ; goCover_33ba7a78e32c__99[3]++;
	return bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
}

func generateToken(length int) string {goCover_33ba7a78e32c__100[0] = 3 ; goCover_33ba7a78e32c__100[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__100[2] = 100 ; goCover_33ba7a78e32c__100[3]++;
	const letters = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
	result := make([]byte, length)
	for i := range result {goCover_33ba7a78e32c__100[5]++;
		num, _ := rand.Int(rand.Reader, big.NewInt(int64(len(letters))))
		result[i] = letters[num.Int64()]
	}
	goCover_33ba7a78e32c__100[4]++;return string(result)
}

/*func hashPassword(p string) ([]byte, error) {
	return bcrypt.GenerateFromPassword([]byte(p), bcrypt.DefaultCost)
}*/

func (a *App) sendActivationEmail(email, token, lang, keyPrefix string) {goCover_33ba7a78e32c__101[0] = 5 ; goCover_33ba7a78e32c__101[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__101[2] = 101 ; goCover_33ba7a78e32c__101[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__101[6]++;
		Infof("MAIL_ENABLED està desactivat; no s'enviarà correu d'activació a %s", email)
		return
	}

	goCover_33ba7a78e32c__101[4]++;activationURL := fmt.Sprintf("http://localhost:8080/activar?token=%s", token)
	subject := T(lang, keyPrefix+".subject")
	body := fmt.Sprintf(T(lang, keyPrefix+".body"), activationURL)

	if err := a.Mail.Send(email, subject, body); err != nil {goCover_33ba7a78e32c__101[7]++;
		Errorf("No s'ha pogut enviar el correu d'activació a %s: %v", email, err)
		return
	}

	goCover_33ba7a78e32c__101[5]++;Infof("Correu d'activació enviat a %s", email)
}

func (a *App) sendPasswordResetEmail(email, url, lang string) {goCover_33ba7a78e32c__102[0] = 5 ; goCover_33ba7a78e32c__102[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__102[2] = 102 ; goCover_33ba7a78e32c__102[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__102[6]++;
		Infof("MAIL_ENABLED està desactivat; no s'enviarà correu de recuperació a %s", email)
		return
	}
	goCover_33ba7a78e32c__102[4]++;subject := T(lang, "email.reset.subject")
	body := fmt.Sprintf(T(lang, "email.reset.body"), url)
	if err := a.Mail.Send(email, subject, body); err != nil {goCover_33ba7a78e32c__102[7]++;
		Errorf("No s'ha pogut enviar el correu de recuperació a %s: %v", email, err)
		return
	}
	goCover_33ba7a78e32c__102[5]++;Infof("Correu de recuperació enviat a %s", email)
}

func (a *App) sendPasswordResetCompletedEmail(email, password, lang string) {goCover_33ba7a78e32c__103[0] = 5 ; goCover_33ba7a78e32c__103[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__103[2] = 103 ; goCover_33ba7a78e32c__103[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__103[6]++;
		Infof("MAIL_ENABLED està desactivat; no s'enviarà correu amb la nova contrasenya a %s", email)
		return
	}
	goCover_33ba7a78e32c__103[4]++;subject := T(lang, "email.reset.complete.subject")
	body := fmt.Sprintf(T(lang, "email.reset.complete.body"), password)
	if err := a.Mail.Send(email, subject, body); err != nil {goCover_33ba7a78e32c__103[7]++;
		Errorf("No s'ha pogut enviar el correu amb la nova contrasenya a %s: %v", email, err)
		return
	}
	goCover_33ba7a78e32c__103[5]++;Infof("Correu amb nova contrasenya enviat a %s", email)
}

func (a *App) sendEmailChangeConfirm(email, token, lang string) {goCover_33ba7a78e32c__104[0] = 4 ; goCover_33ba7a78e32c__104[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__104[2] = 104 ; goCover_33ba7a78e32c__104[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__104[5]++;
		return
	}
	goCover_33ba7a78e32c__104[4]++;url := fmt.Sprintf("http://localhost:8080/perfil/email-confirm?token=%s", token)
	subject := T(lang, "email.change.confirm.subject")
	body := fmt.Sprintf(T(lang, "email.change.confirm.body"), url)
	if err := a.Mail.Send(email, subject, body); err != nil {goCover_33ba7a78e32c__104[6]++;
		Errorf("No s'ha pogut enviar correu de confirmació de canvi d'email a %s: %v", email, err)
	}
}

func (a *App) sendEmailChangeRevert(oldEmail, newEmail, token, lang string) {goCover_33ba7a78e32c__105[0] = 4 ; goCover_33ba7a78e32c__105[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__105[2] = 105 ; goCover_33ba7a78e32c__105[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__105[5]++;
		return
	}
	goCover_33ba7a78e32c__105[4]++;url := fmt.Sprintf("http://localhost:8080/perfil/email-revert?token=%s", token)
	subject := T(lang, "email.change.revert.subject")
	body := fmt.Sprintf(T(lang, "email.change.revert.body"), newEmail, url)
	if err := a.Mail.Send(oldEmail, subject, body); err != nil {goCover_33ba7a78e32c__105[6]++;
		Errorf("No s'ha pogut enviar correu de revert de canvi d'email a %s: %v", oldEmail, err)
	}
}

func (a *App) sendPasswordChangedEmail(email, lang string) {goCover_33ba7a78e32c__106[0] = 4 ; goCover_33ba7a78e32c__106[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__106[2] = 106 ; goCover_33ba7a78e32c__106[3]++;
	if !a.Mail.Enabled {goCover_33ba7a78e32c__106[5]++;
		return
	}
	goCover_33ba7a78e32c__106[4]++;subject := T(lang, "email.password.changed.subject")
	body := T(lang, "email.password.changed.body")
	if err := a.Mail.Send(email, subject, body); err != nil {goCover_33ba7a78e32c__106[6]++;
		Errorf("No s'ha pogut enviar correu de canvi de contrasenya a %s: %v", email, err)
	}
}

func generateSecurePassword(length int) string {goCover_33ba7a78e32c__107[0] = 7 ; goCover_33ba7a78e32c__107[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__107[2] = 107 ; goCover_33ba7a78e32c__107[3]++;
	lower := "abcdefghijklmnopqrstuvwxyz"
	upper := "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
	digits := "0123456789"
	symbols := "!@#$%^&*()-_=+[]{}<>?"
	all := lower + upper + digits + symbols

	result := make([]byte, length)

	// Garantir almenys un caràcter de cada grup principal
	classes := []string{lower, upper, digits, symbols}
	for i := 0; i < 4 && i < length; i++ {goCover_33ba7a78e32c__107[7]++;
		num, _ := rand.Int(rand.Reader, big.NewInt(int64(len(classes[i]))))
		result[i] = classes[i][num.Int64()]
	}

	goCover_33ba7a78e32c__107[4]++;for i := 4; i < length; i++ {goCover_33ba7a78e32c__107[8]++;
		num, _ := rand.Int(rand.Reader, big.NewInt(int64(len(all))))
		result[i] = all[num.Int64()]
	}

	// barreja aleatòriament
	goCover_33ba7a78e32c__107[5]++;for i := len(result) - 1; i > 0; i-- {goCover_33ba7a78e32c__107[9]++;
		jBig, _ := rand.Int(rand.Reader, big.NewInt(int64(i+1)))
		j := int(jBig.Int64())
		result[i], result[j] = result[j], result[i]
	}

	goCover_33ba7a78e32c__107[6]++;return string(result)
}

func writeJSONMessage(w http.ResponseWriter, ok bool, msg string) {goCover_33ba7a78e32c__108[0] = 3 ; goCover_33ba7a78e32c__108[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__108[2] = 108 ; goCover_33ba7a78e32c__108[3]++;
	w.Header().Set("Content-Type", "application/json")
	resp := map[string]string{
		"message": msg,
	}
	if !ok {goCover_33ba7a78e32c__108[5]++;
		resp["error"] = msg
	}
	goCover_33ba7a78e32c__108[4]++;_ = json.NewEncoder(w).Encode(resp)
}

func wantsJSON(r *http.Request) bool {goCover_33ba7a78e32c__109[0] = 5 ; goCover_33ba7a78e32c__109[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__109[2] = 109 ; goCover_33ba7a78e32c__109[3]++;
	accept := r.Header.Get("Accept")
	xrw := strings.ToLower(r.Header.Get("X-Requested-With"))
	ct := r.Header.Get("Content-Type")
	if strings.Contains(accept, "application/json") || strings.Contains(ct, "application/json") {goCover_33ba7a78e32c__109[6]++;
		return true
	}
	goCover_33ba7a78e32c__109[4]++;if xrw == "xmlhttprequest" {goCover_33ba7a78e32c__109[7]++;
		return true
	}
	goCover_33ba7a78e32c__109[5]++;return false
}

func writeRecoverResponse(w http.ResponseWriter, r *http.Request, lang string, status int, ok bool, msg string) {goCover_33ba7a78e32c__110[0] = 5 ; goCover_33ba7a78e32c__110[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__110[2] = 110 ; goCover_33ba7a78e32c__110[3]++;
	if wantsJSON(r) {goCover_33ba7a78e32c__110[6]++;
		w.WriteHeader(status)
		writeJSONMessage(w, ok, msg)
		return
	}

	goCover_33ba7a78e32c__110[4]++;if status >= 400 {goCover_33ba7a78e32c__110[7]++;
		w.WriteHeader(status)
	}
	goCover_33ba7a78e32c__110[5]++;RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
		Error:   ifThen(!ok && status >= 400, msg, ""),
		Success: ifThen(ok, msg, ""),
	})
}

func ifThen(cond bool, a, b string) string {goCover_33ba7a78e32c__111[0] = 3 ; goCover_33ba7a78e32c__111[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__111[2] = 111 ; goCover_33ba7a78e32c__111[3]++;
	if cond {goCover_33ba7a78e32c__111[5]++;
		return a
	}
	goCover_33ba7a78e32c__111[4]++;return b
}

// redact oculta valors sensibles quan es logueja un formulari
func redact(values []string, key string) []string {goCover_33ba7a78e32c__112[0] = 5 ; goCover_33ba7a78e32c__112[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__112[2] = 112 ; goCover_33ba7a78e32c__112[3]++;
	sensitive := map[string]bool{
		"contrassenya":          true,
		"confirmar_contrasenya": true,
		"password":              true,
		"pwd":                   true,
	}
	if sensitive[strings.ToLower(key)] {goCover_33ba7a78e32c__112[5]++;
		masked := make([]string, len(values))
		for i, v := range values {goCover_33ba7a78e32c__112[7]++;
			masked[i] = maskValue(v)
		}
		goCover_33ba7a78e32c__112[6]++;return masked
	}
	goCover_33ba7a78e32c__112[4]++;return values
}

func maskValue(v string) string {goCover_33ba7a78e32c__113[0] = 5 ; goCover_33ba7a78e32c__113[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__113[2] = 113 ; goCover_33ba7a78e32c__113[3]++;
	if v == "" {goCover_33ba7a78e32c__113[6]++;
		return ""
	}
	// Longitud aleatòria (6-12) independent de l'original
	goCover_33ba7a78e32c__113[4]++;min, max := int64(6), int64(12)
	nBig, err := rand.Int(rand.Reader, big.NewInt(max-min+1))
	if err != nil {goCover_33ba7a78e32c__113[7]++;
		return "******"
	}
	goCover_33ba7a78e32c__113[5]++;n := min + nBig.Int64()
	return strings.Repeat("*", int(n))
}

func ParseDate(dateStr string) time.Time {goCover_33ba7a78e32c__114[0] = 3 ; goCover_33ba7a78e32c__114[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__114[2] = 114 ; goCover_33ba7a78e32c__114[3]++;
	t, err := time.Parse("2006-01-02", dateStr)
	if err != nil {goCover_33ba7a78e32c__114[5]++;
		return time.Time{}
	}
	goCover_33ba7a78e32c__114[4]++;return t
}

func (a *App) RegenerarTokenActivacio(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__115[0] = 11 ; goCover_33ba7a78e32c__115[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__115[2] = 115 ; goCover_33ba7a78e32c__115[3]++;
	if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__115[9]++;
		lang := ResolveLang(r)
		w.WriteHeader(http.StatusForbidden)
		RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
			Error: T(lang, "error.csrf"),
		})
		return
	}
	goCover_33ba7a78e32c__115[4]++;lang := ResolveLang(r)
	email := strings.TrimSpace(r.FormValue("email"))
	if email == "" {goCover_33ba7a78e32c__115[10]++;
		w.WriteHeader(http.StatusBadRequest)
		RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
			Error: T(lang, "regenerate.error.emailRequired"),
		})
		return
	}

	goCover_33ba7a78e32c__115[5]++;usuari, err := a.DB.GetUserByEmail(email)
	if err != nil {goCover_33ba7a78e32c__115[11]++;
		w.WriteHeader(http.StatusNotFound)
		RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
			Error: T(lang, "regenerate.error.notFound"),
		})
		return
	}
	goCover_33ba7a78e32c__115[6]++;if usuari.Active {goCover_33ba7a78e32c__115[12]++;
		w.WriteHeader(http.StatusBadRequest)
		RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
			Error: T(lang, "regenerate.error.alreadyActive"),
		})
		return
	}
	goCover_33ba7a78e32c__115[7]++;token := generateToken(32)
	err = a.DB.SaveActivationToken(email, token)
	if err != nil {goCover_33ba7a78e32c__115[13]++;
		w.WriteHeader(http.StatusInternalServerError)
		RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
			Error: T(lang, "regenerate.error.save"),
		})
		return
	}
	goCover_33ba7a78e32c__115[8]++;Infof("Token d'activació regenerat per a %s: %s", email, token)
	Debugf("URL d'activació: http://localhost:8080/activar?token=%s", token)

	// Envia nou correu d'activació amb la mateixa lògica de localització
	a.sendActivationEmail(email, token, lang, "email.activation.regen")

	RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{
		Success: T(lang, "regenerate.success"),
	})
}

func (a *App) MostrarFormulariRegenerarToken(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__116[0] = 1 ; goCover_33ba7a78e32c__116[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__116[2] = 116 ; goCover_33ba7a78e32c__116[3]++;
	RenderTemplate(w, r, "regenerar-token.html", RegenerarTokenPageData{})
}

func (a *App) ProcessarRegenerarToken(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__117[0] = 3 ; goCover_33ba7a78e32c__117[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__117[2] = 117 ; goCover_33ba7a78e32c__117[3]++;
	if r.Method == "POST" {goCover_33ba7a78e32c__117[4]++;
		a.RegenerarTokenActivacio(w, r)
	} else{ goCover_33ba7a78e32c__117[5]++;{
		http.Redirect(w, r, "/regenerar-token", http.StatusSeeOther)
	}}
}

// Perfil – mostra la pàgina d'ajustos de compte per a usuaris autenticats.
func (a *App) Perfil(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__118[0] = 18 ; goCover_33ba7a78e32c__118[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__118[2] = 118 ; goCover_33ba7a78e32c__118[3]++;
	user, ok := a.VerificarSessio(r)
	if !ok || user == nil {goCover_33ba7a78e32c__118[11]++;
		http.Redirect(w, r, "/", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__118[4]++;lang := ResolveLang(r)
	if pref := strings.TrimSpace(user.PreferredLang); pref != "" && isSupportedLang(pref) {goCover_33ba7a78e32c__118[12]++;
		lang = pref
		setLangCookie(w, r, lang)
	}

	goCover_33ba7a78e32c__118[5]++;var privacy *db.PrivacySettings
	if p, err := a.DB.GetPrivacySettings(user.ID); err == nil {goCover_33ba7a78e32c__118[13]++;
		privacy = p
	}
	goCover_33ba7a78e32c__118[6]++;if privacy == nil {goCover_33ba7a78e32c__118[14]++;
		privacy = defaultPrivacySettings()
	}

	goCover_33ba7a78e32c__118[7]++;memberSince := formatDateDisplay(user.CreatedAt)
	birthInput := formatDateInput(user.DataNaixament)

	spokenSlice := []string{}
	if strings.TrimSpace(user.SpokenLangs) != "" {goCover_33ba7a78e32c__118[15]++;
		for _, v := range strings.Split(user.SpokenLangs, ",") {goCover_33ba7a78e32c__118[16]++;
			if t := strings.TrimSpace(v); t != "" {goCover_33ba7a78e32c__118[17]++;
				spokenSlice = append(spokenSlice, t)
			}
		}
	}
	goCover_33ba7a78e32c__118[8]++;spokenSet := map[string]bool{}
	for _, v := range spokenSlice {goCover_33ba7a78e32c__118[18]++;
		spokenSet[v] = true
	}

	goCover_33ba7a78e32c__118[9]++;activeTab := r.URL.Query().Get("tab")
	switch activeTab {
	case "generals", "contrasenya", "privacitat", "eliminar":goCover_33ba7a78e32c__118[19]++;
	default:goCover_33ba7a78e32c__118[20]++;
		activeTab = "generals"
	}

	goCover_33ba7a78e32c__118[10]++;canManageArxius := a.CanManageArxius(user)

	RenderPrivateTemplateLang(w, r, "perfil.html", lang, map[string]interface{}{
		"User":               user,
		"Privacy":            privacy,
		"MemberSince":        memberSince,
		"BirthInputValue":    birthInput,
		"MemberSinceDisplay": memberSince,
		"Success":            r.URL.Query().Get("success"),
		"Error":              r.URL.Query().Get("error"),
		"ActiveTab":          activeTab,
		"LangOptions":        []string{"cat", "en", "oc"},
		"SpokenSlice":        spokenSlice,
		"SpokenSet":          spokenSet,
		"CanManageArxius":    canManageArxius,
	})
}

func formatDateInput(dateStr string) string {goCover_33ba7a78e32c__119[0] = 6 ; goCover_33ba7a78e32c__119[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__119[2] = 119 ; goCover_33ba7a78e32c__119[3]++;
	if dateStr == "" {goCover_33ba7a78e32c__119[6]++;
		return ""
	}
	goCover_33ba7a78e32c__119[4]++;layouts := []string{
		time.RFC3339,
		"2006-01-02 15:04:05",
		"2006-01-02",
	}
	for _, layout := range layouts {goCover_33ba7a78e32c__119[7]++;
		if t, err := time.Parse(layout, dateStr); err == nil {goCover_33ba7a78e32c__119[8]++;
			return t.Format("2006-01-02")
		}
	}
	goCover_33ba7a78e32c__119[5]++;return ""
}

func formatDateDisplay(dateStr string) string {goCover_33ba7a78e32c__120[0] = 6 ; goCover_33ba7a78e32c__120[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__120[2] = 120 ; goCover_33ba7a78e32c__120[3]++;
	if dateStr == "" {goCover_33ba7a78e32c__120[6]++;
		return ""
	}
	goCover_33ba7a78e32c__120[4]++;layouts := []string{
		time.RFC3339,
		"2006-01-02 15:04:05",
		"2006-01-02",
	}
	for _, layout := range layouts {goCover_33ba7a78e32c__120[7]++;
		if t, err := time.Parse(layout, dateStr); err == nil {goCover_33ba7a78e32c__120[8]++;
			return t.Format("02/01/2006")
		}
	}
	goCover_33ba7a78e32c__120[5]++;return dateStr
}

func defaultPrivacySettings() *db.PrivacySettings {goCover_33ba7a78e32c__121[0] = 1 ; goCover_33ba7a78e32c__121[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__121[2] = 121 ; goCover_33ba7a78e32c__121[3]++;
	return &db.PrivacySettings{
		NomVisibility:       "private",
		CognomsVisibility:   "private",
		EmailVisibility:     "private",
		BirthVisibility:     "private",
		PaisVisibility:      "public",
		EstatVisibility:     "private",
		ProvinciaVisibility: "private",
		PoblacioVisibility:  "private",
		PostalVisibility:    "private",
		AddressVisibility:   "private",
		EmploymentVisibility: "private",
		ProfessionVisibility: "private",
		PhoneVisibility:     "private",
		PreferredLangVisibility: "private",
		SpokenLangsVisibility: "private",
		ShowActivity:        true,
		ProfilePublic:       true,
		NotifyEmail:         true,
		AllowContact:        true,
	}
}

func resolveUserLang(r *http.Request, user *db.User) string {goCover_33ba7a78e32c__122[0] = 4 ; goCover_33ba7a78e32c__122[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__122[2] = 122 ; goCover_33ba7a78e32c__122[3]++;
	lang := ResolveLang(r)
	if user != nil {goCover_33ba7a78e32c__122[5]++;
		if l := normalizeLang(strings.TrimSpace(user.PreferredLang)); l != "" && isSupportedLang(l) {goCover_33ba7a78e32c__122[6]++;
			return l
		}
	}
	goCover_33ba7a78e32c__122[4]++;return lang
}

func setLangCookie(w http.ResponseWriter, r *http.Request, lang string) {goCover_33ba7a78e32c__123[0] = 5 ; goCover_33ba7a78e32c__123[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__123[2] = 123 ; goCover_33ba7a78e32c__123[3]++;
	if lang == "" {goCover_33ba7a78e32c__123[6]++;
		return
	}
	goCover_33ba7a78e32c__123[4]++;env := strings.ToLower(os.Getenv("ENVIRONMENT"))
	secure := true
	sameSite := http.SameSiteStrictMode
	if env == "development" {goCover_33ba7a78e32c__123[7]++;
		secure = r.TLS != nil
		sameSite = http.SameSiteLaxMode
	}
	goCover_33ba7a78e32c__123[5]++;http.SetCookie(w, &http.Cookie{
		Name:     "lang",
		Value:    lang,
		Path:     "/",
		HttpOnly: false,
		SameSite: sameSite,
		Secure:   secure,
	})
}

// ActualitzarPerfilDades – Desa dades generals i privacitat; gestiona canvi de correu amb confirmació.
func (a *App) ActualitzarPerfilDades(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__124[0] = 20 ; goCover_33ba7a78e32c__124[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__124[2] = 124 ; goCover_33ba7a78e32c__124[3]++;
	user, ok := a.VerificarSessio(r)
	if !ok || user == nil {goCover_33ba7a78e32c__124[12]++;
		http.Redirect(w, r, "/", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__124[4]++;lang := ResolveLang(r)
	if pref := strings.TrimSpace(user.PreferredLang); pref != "" && isSupportedLang(pref) {goCover_33ba7a78e32c__124[13]++;
		lang = pref
		setLangCookie(w, r, lang)
	}
	goCover_33ba7a78e32c__124[5]++;if r.Method != http.MethodPost {goCover_33ba7a78e32c__124[14]++;
		http.Redirect(w, r, "/perfil?tab=generals", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__124[6]++;if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__124[15]++;
		http.Redirect(w, r, "/perfil?tab=generals&error="+url.QueryEscape(T(lang, "error.csrf")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__124[7]++;if err := r.ParseForm(); err != nil {goCover_33ba7a78e32c__124[16]++;
		http.Redirect(w, r, "/perfil?tab=generals&error="+url.QueryEscape(T(lang, "error.user.create")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__124[8]++;originalEmail := user.Email
	newEmail := strings.TrimSpace(r.FormValue("correu"))

	user.Name = r.FormValue("nom")
	user.Surname = r.FormValue("cognoms")
	user.DataNaixament = r.FormValue("data_naixement")
	user.Pais = r.FormValue("pais")
	user.Estat = r.FormValue("estat")
	user.Provincia = r.FormValue("provincia")
	user.Poblacio = r.FormValue("poblacio")
	user.CodiPostal = r.FormValue("codi_postal")
	user.Address = r.FormValue("adreca")
	user.Employment = r.FormValue("situacio_laboral")
	user.Profession = r.FormValue("professio")
	user.Phone = r.FormValue("telefon")
	user.PreferredLang = r.FormValue("idioma_preferit")
	user.SpokenLangs = strings.TrimSpace(r.FormValue("idiomes_parla"))

	if err := a.DB.UpdateUserProfile(user); err != nil {goCover_33ba7a78e32c__124[17]++;
		http.Redirect(w, r, "/perfil?tab=generals&error="+url.QueryEscape(T(lang, "error.user.create")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__124[9]++;privacy := defaultPrivacySettings()
	if current, err := a.DB.GetPrivacySettings(user.ID); err == nil && current != nil {goCover_33ba7a78e32c__124[18]++;
		privacy = current
	}
	// Actualitza només els camps presents al formulari de dades generals
	goCover_33ba7a78e32c__124[10]++;privacy.UserID = user.ID
	privacy.NomVisibility = visibilityValue(r.FormValue("nom_visibility"))
	privacy.CognomsVisibility = visibilityValue(r.FormValue("cognoms_visibility"))
	privacy.EmailVisibility = visibilityValue(r.FormValue("correu_visibility"))
	privacy.BirthVisibility = visibilityValue(r.FormValue("naixement_visibility"))
	privacy.PaisVisibility = visibilityValue(r.FormValue("pais_visibility"))
	privacy.EstatVisibility = visibilityValue(r.FormValue("estat_visibility"))
	privacy.ProvinciaVisibility = visibilityValue(r.FormValue("provincia_visibility"))
	privacy.PoblacioVisibility = visibilityValue(r.FormValue("poblacio_visibility"))
	privacy.PostalVisibility = visibilityValue(r.FormValue("codi_postal_visibility"))
	privacy.AddressVisibility = visibilityValue(r.FormValue("adreca_visibility"))
	privacy.EmploymentVisibility = visibilityValue(r.FormValue("situacio_visibility"))
	privacy.ProfessionVisibility = visibilityValue(r.FormValue("professio_visibility"))
	privacy.PhoneVisibility = visibilityValue(r.FormValue("telefon_visibility"))
	privacy.PreferredLangVisibility = visibilityValue(r.FormValue("idioma_preferit_visibility"))
	privacy.SpokenLangsVisibility = visibilityValue(r.FormValue("idiomes_parla_visibility"))
	privacy.ShowActivity = r.FormValue("mostrar_estadistiques_public") == "on"
	// ProfilePublic, NotifyEmail i AllowContact provenen del formulari de privacitat; els mantenim.

	_ = a.DB.SavePrivacySettings(user.ID, privacy)

	// Si l'email ha canviat, iniciar procés de confirmació
	if newEmail != "" && newEmail != originalEmail {goCover_33ba7a78e32c__124[19]++;
		if _, err := mail.ParseAddress(newEmail); err == nil {goCover_33ba7a78e32c__124[21]++;
			confirmToken := generateToken(32)
			revertToken := generateToken(32)
			expConfirm := time.Now().Add(24 * time.Hour).Format("2006-01-02 15:04:05")
			expRevert := time.Now().Add(365 * 24 * time.Hour).Format("2006-01-02 15:04:05")
			if err := a.DB.CreateEmailChange(user.ID, newEmail, confirmToken, expConfirm, revertToken, expRevert, lang); err == nil {goCover_33ba7a78e32c__124[22]++;
				a.sendEmailChangeConfirm(newEmail, confirmToken, lang)
				http.Redirect(w, r, "/perfil?tab=generals&success="+url.QueryEscape(T(lang, "profile.email.change.pending")), http.StatusSeeOther)
				return
			}
		}
		goCover_33ba7a78e32c__124[20]++;http.Redirect(w, r, "/perfil?tab=generals&error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__124[11]++;http.Redirect(w, r, "/perfil?tab=generals&success="+url.QueryEscape(T(lang, "profile.save.success")), http.StatusSeeOther)
}

// ActualitzarPerfilPrivacitat – desa només preferències de privacitat/comunicacions.
func (a *App) ActualitzarPerfilPrivacitat(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__125[0] = 15 ; goCover_33ba7a78e32c__125[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__125[2] = 125 ; goCover_33ba7a78e32c__125[3]++;
	user, ok := a.VerificarSessio(r)
	if !ok || user == nil {goCover_33ba7a78e32c__125[11]++;
		http.Redirect(w, r, "/", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__125[4]++;lang := ResolveLang(r)
	if pref := strings.TrimSpace(user.PreferredLang); pref != "" && isSupportedLang(pref) {goCover_33ba7a78e32c__125[12]++;
		lang = pref
		setLangCookie(w, r, lang)
	}
	goCover_33ba7a78e32c__125[5]++;if r.Method != http.MethodPost {goCover_33ba7a78e32c__125[13]++;
		http.Redirect(w, r, "/perfil?tab=privacitat", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__125[6]++;if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__125[14]++;
		http.Redirect(w, r, "/perfil?tab=privacitat&error="+url.QueryEscape(T(lang, "error.csrf")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__125[7]++;if err := r.ParseForm(); err != nil {goCover_33ba7a78e32c__125[15]++;
		http.Redirect(w, r, "/perfil?tab=privacitat&error="+url.QueryEscape(T(lang, "error.user.create")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__125[8]++;privacy, err := a.DB.GetPrivacySettings(user.ID)
	if err != nil || privacy == nil {goCover_33ba7a78e32c__125[16]++;
		privacy = defaultPrivacySettings()
	}

	goCover_33ba7a78e32c__125[9]++;privacy.ProfilePublic = r.FormValue("perfil_visibility") != "private"
	privacy.NotifyEmail = r.FormValue("notificacions_correu") == "on"
	privacy.AllowContact = r.FormValue("contacte_altres_usuaris") == "on"

	if err := a.DB.SavePrivacySettings(user.ID, privacy); err != nil {goCover_33ba7a78e32c__125[17]++;
		http.Redirect(w, r, "/perfil?tab=privacitat&error="+url.QueryEscape(T(lang, "profile.save.error")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__125[10]++;http.Redirect(w, r, "/perfil?tab=privacitat&success="+url.QueryEscape(T(lang, "profile.save.success")), http.StatusSeeOther)
}

// ActualitzarPerfilContrasenya – valida la contrasenya actual i actualitza a una de nova.
func (a *App) ActualitzarPerfilContrasenya(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__126[0] = 23 ; goCover_33ba7a78e32c__126[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__126[2] = 126 ; goCover_33ba7a78e32c__126[3]++;
	user, ok := a.VerificarSessio(r)
	if !ok || user == nil {goCover_33ba7a78e32c__126[15]++;
		http.Redirect(w, r, "/", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[4]++;lang := ResolveLang(r)
	if pref := strings.TrimSpace(user.PreferredLang); pref != "" && isSupportedLang(pref) {goCover_33ba7a78e32c__126[16]++;
		lang = pref
		setLangCookie(w, r, lang)
	}
	goCover_33ba7a78e32c__126[5]++;if r.Method != http.MethodPost {goCover_33ba7a78e32c__126[17]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya", http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[6]++;if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__126[18]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "error.csrf")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[7]++;if err := r.ParseForm(); err != nil {goCover_33ba7a78e32c__126[19]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.generic")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__126[8]++;current := r.FormValue("contrasenya_actual")
	newPass := r.FormValue("nova_contrasenya")
	confirm := r.FormValue("confirmar_contrasenya")

	if current == "" || newPass == "" || confirm == "" {goCover_33ba7a78e32c__126[20]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.required")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[9]++;if newPass != confirm {goCover_33ba7a78e32c__126[21]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.mismatch")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[10]++;if err := bcrypt.CompareHashAndPassword(user.Password, []byte(current)); err != nil {goCover_33ba7a78e32c__126[22]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.current")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[11]++;if err := bcrypt.CompareHashAndPassword(user.Password, []byte(newPass)); err == nil {goCover_33ba7a78e32c__126[23]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.same")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__126[12]++;hash, err := generateHash(newPass)
	if err != nil {goCover_33ba7a78e32c__126[24]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.generic")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__126[13]++;if err := a.DB.UpdateUserPassword(user.ID, hash); err != nil {goCover_33ba7a78e32c__126[25]++;
		http.Redirect(w, r, "/perfil?tab=contrasenya&error="+url.QueryEscape(T(lang, "profile.password.error.generic")), http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__126[14]++;a.sendPasswordChangedEmail(user.Email, lang)
	http.Redirect(w, r, "/perfil?tab=contrasenya&success="+url.QueryEscape(T(lang, "profile.password.success")), http.StatusSeeOther)
}

func visibilityValue(v string) string {goCover_33ba7a78e32c__127[0] = 3 ; goCover_33ba7a78e32c__127[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__127[2] = 127 ; goCover_33ba7a78e32c__127[3]++;
	if strings.ToLower(v) == "public" {goCover_33ba7a78e32c__127[5]++;
		return "public"
	}
	goCover_33ba7a78e32c__127[4]++;return "private"
}

func (a *App) ConfirmarCanviEmail(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__128[0] = 9 ; goCover_33ba7a78e32c__128[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__128[2] = 128 ; goCover_33ba7a78e32c__128[3]++;
	lang := ResolveLang(r)
	token := r.URL.Query().Get("token")
	if token == "" {goCover_33ba7a78e32c__128[8]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__128[4]++;change, err := a.DB.ConfirmEmailChange(token)
	if err != nil {goCover_33ba7a78e32c__128[9]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__128[5]++;if err := a.DB.UpdateUserEmail(change.UserID, change.NewEmail); err != nil {goCover_33ba7a78e32c__128[10]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__128[6]++;if helper, ok := a.DB.(interface{ markEmailChangeConfirmed(id int) error }); ok {goCover_33ba7a78e32c__128[11]++;
		_ = helper.markEmailChangeConfirmed(change.ID)
	}
	goCover_33ba7a78e32c__128[7]++;a.sendEmailChangeRevert(change.OldEmail, change.NewEmail, change.TokenRevert, change.Lang)
	http.Redirect(w, r, "/perfil?success="+url.QueryEscape(T(change.Lang, "profile.email.change.confirmed")), http.StatusSeeOther)
}

func (a *App) RevertirCanviEmail(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__129[0] = 9 ; goCover_33ba7a78e32c__129[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__129[2] = 129 ; goCover_33ba7a78e32c__129[3]++;
	lang := ResolveLang(r)
	token := r.URL.Query().Get("token")
	if token == "" {goCover_33ba7a78e32c__129[8]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__129[4]++;change, err := a.DB.RevertEmailChange(token)
	if err != nil {goCover_33ba7a78e32c__129[9]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__129[5]++;if err := a.DB.UpdateUserEmail(change.UserID, change.OldEmail); err != nil {goCover_33ba7a78e32c__129[10]++;
		http.Redirect(w, r, "/perfil?error="+url.QueryEscape(T(lang, "profile.email.change.invalid")), http.StatusSeeOther)
		return
	}
	goCover_33ba7a78e32c__129[6]++;if helper, ok := a.DB.(interface{ markEmailChangeReverted(id int) error }); ok {goCover_33ba7a78e32c__129[11]++;
		_ = helper.markEmailChangeReverted(change.ID)
	}
	goCover_33ba7a78e32c__129[7]++;http.Redirect(w, r, "/perfil?success="+url.QueryEscape(T(change.Lang, "profile.email.change.reverted")), http.StatusSeeOther)
}

// GestionarRecuperacio gestiona POST de sol·licitud i GET del token de recuperació
func (a *App) GestionarRecuperacio(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__130[0] = 5 ; goCover_33ba7a78e32c__130[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__130[2] = 130 ; goCover_33ba7a78e32c__130[3]++;
	if r.Method == "POST" {goCover_33ba7a78e32c__130[6]++;
		a.SolicitarRecuperarContrasenya(w, r)
		return
	}
	goCover_33ba7a78e32c__130[4]++;if r.Method == "GET" && r.URL.Query().Get("token") != "" {goCover_33ba7a78e32c__130[7]++;
		a.ValidarRecuperarContrasenya(w, r)
		return
	}
	goCover_33ba7a78e32c__130[5]++;http.Error(w, "Mètode no permès", http.StatusMethodNotAllowed)
}

// SolicitarRecuperarContrasenya processa la petició de recuperació.
func (a *App) SolicitarRecuperarContrasenya(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__131[0] = 15 ; goCover_33ba7a78e32c__131[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__131[2] = 131 ; goCover_33ba7a78e32c__131[3]++;
	lang := ResolveLang(r)

	if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__131[11]++;
		w.WriteHeader(http.StatusForbidden)
		writeRecoverResponse(w, r, lang, http.StatusForbidden, false, T(lang, "error.csrf"))
		return
	}

	goCover_33ba7a78e32c__131[4]++;if err := r.ParseForm(); err != nil {goCover_33ba7a78e32c__131[12]++;
		w.WriteHeader(http.StatusBadRequest)
		writeRecoverResponse(w, r, lang, http.StatusBadRequest, false, T(lang, "recover.error.generic"))
		return
	}

	goCover_33ba7a78e32c__131[5]++;email := strings.TrimSpace(r.FormValue("email"))
	captcha := r.FormValue("captcha")

	if email == "" {goCover_33ba7a78e32c__131[13]++;
		w.WriteHeader(http.StatusBadRequest)
		writeRecoverResponse(w, r, lang, http.StatusBadRequest, false, T(lang, "regenerate.error.emailRequired"))
		return
	}
	goCover_33ba7a78e32c__131[6]++;if _, err := mail.ParseAddress(email); err != nil {goCover_33ba7a78e32c__131[14]++;
		w.WriteHeader(http.StatusBadRequest)
		writeRecoverResponse(w, r, lang, http.StatusBadRequest, false, T(lang, "error.email.invalid"))
		return
	}
	goCover_33ba7a78e32c__131[7]++;if captcha != "8" {goCover_33ba7a78e32c__131[15]++;
		w.WriteHeader(http.StatusBadRequest)
		writeRecoverResponse(w, r, lang, http.StatusBadRequest, false, T(lang, "error.captcha.invalid"))
		return
	}

	goCover_33ba7a78e32c__131[8]++;token := generateToken(32)
	expiry := time.Now().Add(24 * time.Hour).Format("2006-01-02 15:04:05")

	created, err := a.DB.CreatePasswordReset(email, token, expiry, lang)
	if err != nil {goCover_33ba7a78e32c__131[16]++;
		Errorf("Error creant sol·licitud de recuperació per %s: %v", email, err)
		// No revelem l'error, retornem missatge genèric
		writeRecoverResponse(w, r, lang, http.StatusOK, true, T(lang, "recover.info.sent"))
		return
	}

	goCover_33ba7a78e32c__131[9]++;if created {goCover_33ba7a78e32c__131[17]++;
		resetURL := fmt.Sprintf("http://localhost:8080/recuperar?token=%s", token)
		a.sendPasswordResetEmail(email, resetURL, lang)
	}

	goCover_33ba7a78e32c__131[10]++;writeRecoverResponse(w, r, lang, http.StatusOK, true, T(lang, "recover.info.sent"))
}

// ValidarRecuperarContrasenya valida el token i genera una nova contrasenya enviada per correu.
func (a *App) ValidarRecuperarContrasenya(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__132[0] = 13 ; goCover_33ba7a78e32c__132[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__132[2] = 132 ; goCover_33ba7a78e32c__132[3]++;
	lang := ResolveLang(r)
	token := strings.TrimSpace(r.URL.Query().Get("token"))
	if token == "" {goCover_33ba7a78e32c__132[10]++;
		w.WriteHeader(http.StatusBadRequest)
		RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
			Error: T(lang, "recover.result.invalid"),
		})
		return
	}

	goCover_33ba7a78e32c__132[4]++;req, err := a.DB.GetPasswordReset(token)
	if err != nil {goCover_33ba7a78e32c__132[11]++;
		w.WriteHeader(http.StatusBadRequest)
		RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
			Error: T(lang, "recover.result.invalid"),
		})
		return
	}

	goCover_33ba7a78e32c__132[5]++;newPass := generateSecurePassword(16)
	hash, err := generateHash(newPass)
	if err != nil {goCover_33ba7a78e32c__132[12]++;
		w.WriteHeader(http.StatusInternalServerError)
		RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
			Error: T(lang, "recover.result.error"),
		})
		return
	}

	goCover_33ba7a78e32c__132[6]++;if err := a.DB.UpdateUserPassword(req.UserID, hash); err != nil {goCover_33ba7a78e32c__132[13]++;
		w.WriteHeader(http.StatusInternalServerError)
		RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
			Error: T(lang, "recover.result.error"),
		})
		return
	}

	// Marquem la petició com usada (best-effort)
	goCover_33ba7a78e32c__132[7]++;if err := a.DB.MarkPasswordResetUsed(req.ID); err != nil {goCover_33ba7a78e32c__132[14]++;
		Errorf("No s'ha pogut marcar password_resets %d com usada: %v", req.ID, err)
	}

	goCover_33ba7a78e32c__132[8]++;resetLang := req.Lang
	if resetLang == "" {goCover_33ba7a78e32c__132[15]++;
		resetLang = lang
	}
	goCover_33ba7a78e32c__132[9]++;a.sendPasswordResetCompletedEmail(req.Email, newPass, resetLang)

	RenderTemplate(w, r, "recover-result.html", RecuperarResultPageData{
		Success: T(lang, "recover.result.sent"),
	})
}
func (a *App) ActivarUsuariHTTP(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__133[0] = 5 ; goCover_33ba7a78e32c__133[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__133[2] = 133 ; goCover_33ba7a78e32c__133[3]++;
	// No exigim CSRF aquí perquè és GET via enllaç de correu
	token := r.URL.Query().Get("token")
	if token == "" {goCover_33ba7a78e32c__133[6]++;
		RenderTemplate(w, r, "activat-user.html", ActivacioPageData{
			Activat: false,
		})
		return
	}

	goCover_33ba7a78e32c__133[4]++;Infof("Intentant activar usuari amb token: %s", token)
	err := a.DB.ActivateUser(token)
	if err != nil {goCover_33ba7a78e32c__133[7]++;
		Errorf("Error activant usuari: %v", err)
		RenderTemplate(w, r, "activat-user.html", ActivacioPageData{
			Activat: false,
		})
		return
	}
	goCover_33ba7a78e32c__133[5]++;Infof("Usuari activat correctament amb token: %s", token)
	RenderTemplate(w, r, "activat-user.html", ActivacioPageData{
		Activat: true,
	})
}

// IniciarSessio – Autentica un usuari i crea una sessió
func (a *App) IniciarSessio(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__134[0] = 31 ; goCover_33ba7a78e32c__134[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__134[2] = 134 ; goCover_33ba7a78e32c__134[3]++;
	Debugf("IniciarSessio cridada - Mètode: %s", r.Method)
	lang := ResolveLang(r)

	if r.Method != "POST" {goCover_33ba7a78e32c__134[17]++;
		Debugf("Mètode no permès: %s", r.Method)
		http.Error(w, "Mètode no permès", http.StatusMethodNotAllowed)
		return
	}

	// Validar CSRF
	goCover_33ba7a78e32c__134[4]++;if !validateCSRF(r, r.FormValue("csrf_token")) {goCover_33ba7a78e32c__134[18]++;
		http.Error(w, "Error: accés no autoritzat", http.StatusForbidden)
		return
	}

	goCover_33ba7a78e32c__134[5]++;ipStr := getIP(r)
	Infof("Intent d'inici de sessió des de: %s", ipStr)

	// Verificar si l'usuari ja està autenticat
	if user, authenticated := a.VerificarSessio(r); authenticated {goCover_33ba7a78e32c__134[19]++;
		Infof("Usuari %s ja està autenticat, redirigint a /inici", user.Usuari)
		http.Redirect(w, r, "/inici", http.StatusSeeOther)
		return
	}

	// Captura els camps del formulari
	goCover_33ba7a78e32c__134[6]++;Debugf("Parsejant formulari...")
	Debugf("Content-Type: %s", r.Header.Get("Content-Type"))
	Debugf("Content-Length: %s", r.Header.Get("Content-Length"))

	// Parsejar el formulari primer
	ct := r.Header.Get("Content-Type")
	if strings.HasPrefix(ct, "multipart/form-data") {goCover_33ba7a78e32c__134[20]++;
		if err := r.ParseMultipartForm(2 << 20); err != nil {goCover_33ba7a78e32c__134[21]++; // 2MB
			Debugf("Error ParseMultipartForm: %v", err)
		}
	} else{ goCover_33ba7a78e32c__134[22]++;{
		if err := r.ParseForm(); err != nil {goCover_33ba7a78e32c__134[23]++;
			Debugf("Error ParseForm: %v", err)
		}
	}}

	// Debug: veure tots els valors del formulari
	goCover_33ba7a78e32c__134[7]++;Debugf("Tots els valors del formulari:")
	for key, values := range r.Form {goCover_33ba7a78e32c__134[24]++;
		Debugf("  %s: %v", key, redact(values, key))
	}

	// Debug: veure també els valors de PostForm
	goCover_33ba7a78e32c__134[8]++;Debugf("Tots els valors de PostForm:")
	for key, values := range r.PostForm {goCover_33ba7a78e32c__134[25]++;
		Debugf("  %s: %v", key, redact(values, key))
	}

	goCover_33ba7a78e32c__134[9]++;if r.MultipartForm != nil {goCover_33ba7a78e32c__134[26]++;
		Debugf("Tots els valors de MultipartForm.Value:")
		for key, values := range r.MultipartForm.Value {goCover_33ba7a78e32c__134[27]++;
			Debugf("  %s: %v", key, redact(values, key))
		}
	}

	goCover_33ba7a78e32c__134[10]++;usernameOrEmail := r.FormValue("usuari")
	password := r.FormValue("contrassenya")
	captcha := r.FormValue("captcha")
	mantenirSessio := r.FormValue("mantenir_sessio")

	Debugf("Dades del formulari - Usuari: %s, Contrasenya: [%d chars], CAPTCHA: %s",
		usernameOrEmail, 0, captcha)

	// Validacions bàsiques
	if usernameOrEmail == "" || password == "" {goCover_33ba7a78e32c__134[28]++;
		Debugf("Validació fallida: usuari o contrasenya buits")
		RenderTemplate(w, r, "index.html", IndexPageData{
			Error: T(lang, "error.login.required"),
		})
		return
	}

	// Validar CAPTCHA
	goCover_33ba7a78e32c__134[11]++;if captcha != "8" {goCover_33ba7a78e32c__134[29]++;
		Debugf("CAPTCHA invàlid: %s (esperat: 8)", captcha)
		RenderTemplate(w, r, "index.html", IndexPageData{
			Error: T(lang, "error.captcha.invalid"),
		})
		return
	}

	goCover_33ba7a78e32c__134[12]++;Debugf("Validacions bàsiques passades, procedint a autenticar...")

	// Autenticar usuari
	user, err := a.DB.AuthenticateUser(usernameOrEmail, password)
	if err != nil {goCover_33ba7a78e32c__134[30]++;
		Debugf("Error d'autenticació per a %s: %v", usernameOrEmail, err)
		RenderTemplate(w, r, "index.html", IndexPageData{
			Error: T(lang, "error.login.invalid"),
		})
		return
	}

	goCover_33ba7a78e32c__134[13]++;Infof("Autenticació exitosa per a usuari: %s (ID: %d)", user.Usuari, user.ID)

	// Crear sessió
	sessionID := generateToken(32)
	sessionExpiry := time.Now().Add(24 * time.Hour) // 24 hores per defecte

	if mantenirSessio == "on" {goCover_33ba7a78e32c__134[31]++;
		sessionExpiry = time.Now().Add(7 * 24 * time.Hour) // 1 setmana si marca el checkbox
	}

	goCover_33ba7a78e32c__134[14]++;Debugf("Creant sessió amb ID: %s", sessionID)

	// Guardar sessió a la base de dades
	err = a.DB.SaveSession(sessionID, user.ID, sessionExpiry.Format("2006-01-02 15:04:05"))
	if err != nil {goCover_33ba7a78e32c__134[32]++;
		Errorf("Error guardant sessió: %v", err)
		http.Error(w, "Error intern del servidor", http.StatusInternalServerError)
		return
	}

	goCover_33ba7a78e32c__134[15]++;Debugf("Sessió guardada a la base de dades")

	// Crear cookie de sessió
	env := strings.ToLower(os.Getenv("ENVIRONMENT"))
	secure := true
	sameSite := http.SameSiteStrictMode
	if env == "development" {goCover_33ba7a78e32c__134[33]++;
		secure = r.TLS != nil
		sameSite = http.SameSiteLaxMode
	}

	goCover_33ba7a78e32c__134[16]++;http.SetCookie(w, &http.Cookie{
		Name:     "cg_session",
		Value:    sessionID,
		Expires:  sessionExpiry,
		Path:     "/",
		HttpOnly: true,
		Secure:   secure,   // Secure en entorns reals; en dev depèn de TLS
		SameSite: sameSite, // Strict per reduir CSRF; Lax en dev per comoditat
	})

	Debugf("Cookie de sessió creada (Secure=%v, SameSite=Lax, Expires=%s)", secure, sessionExpiry.Format(time.RFC3339))

	// Redirigir a la pàgina privada
	Debugf("Redirigint a /inici")
	http.Redirect(w, r, "/inici", http.StatusSeeOther)
}

// VerificarSessio – Comprova si un usuari té una sessió vàlida
func (a *App) VerificarSessio(r *http.Request) (*db.User, bool) {goCover_33ba7a78e32c__135[0] = 7 ; goCover_33ba7a78e32c__135[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__135[2] = 135 ; goCover_33ba7a78e32c__135[3]++;
	cookie, err := r.Cookie("cg_session")
	if err != nil {goCover_33ba7a78e32c__135[7]++;
		Debugf("[VerificarSessio] No s'ha trobat cookie de sessió: %v", err)
		return nil, false
	}

	goCover_33ba7a78e32c__135[4]++;sessionID := cookie.Value
	if sessionID == "" {goCover_33ba7a78e32c__135[8]++;
		Debugf("[VerificarSessio] Cookie de sessió buida")
		return nil, false
	}

	goCover_33ba7a78e32c__135[5]++;Debugf("[VerificarSessio] Verificant sessió: %s", sessionID)

	// Buscar l'usuari associat a aquesta sessió
	user, err := a.DB.GetSessionUser(sessionID)
	if err != nil {goCover_33ba7a78e32c__135[9]++;
		Debugf("[VerificarSessio] Sessió no vàlida o expirada: %v", err)
		return nil, false
	}

	goCover_33ba7a78e32c__135[6]++;Debugf("[VerificarSessio] Sessió vàlida per a usuari: %s (ID: %d)", user.Usuari, user.ID)
	return user, true
}

// TancarSessio – elimina la sessió actual (cookie + BD) i redirigeix a l'inici
func (a *App) TancarSessio(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__136[0] = 7 ; goCover_33ba7a78e32c__136[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__136[2] = 136 ; goCover_33ba7a78e32c__136[3]++;
	lang := ResolveLang(r)

	cookie, err := r.Cookie("cg_session")
	if err != nil || cookie.Value == "" {goCover_33ba7a78e32c__136[7]++;
		http.Redirect(w, r, "/", http.StatusSeeOther)
		return
	}

	goCover_33ba7a78e32c__136[4]++;sessionID := cookie.Value

	if err := a.DB.DeleteSession(sessionID); err != nil {goCover_33ba7a78e32c__136[8]++;
		Errorf("[logout] error eliminant sessió %s: %v", sessionID, err)
	}

	// Esborra la cookie
	goCover_33ba7a78e32c__136[5]++;env := strings.ToLower(os.Getenv("ENVIRONMENT"))
	secure := true
	sameSite := http.SameSiteStrictMode
	if env == "development" {goCover_33ba7a78e32c__136[9]++;
		secure = r.TLS != nil
		sameSite = http.SameSiteLaxMode
	}
	goCover_33ba7a78e32c__136[6]++;http.SetCookie(w, &http.Cookie{
		Name:     "cg_session",
		Value:    "",
		Path:     "/",
		MaxAge:   -1,
		HttpOnly: true,
		SameSite: sameSite,
		Secure:   secure,
	})

	// Missatge opcional via querystring o flash; per ara només redirigim
	redirectTarget := "/"
	// Si vols redirigir a login amb idioma, podríem fer servir lang
	Infof("[logout] sessió %s tancada, redirigint a %s (lang=%s)", sessionID, redirectTarget, lang)
	http.Redirect(w, r, redirectTarget, http.StatusSeeOther)
}

// CheckAvailability – endpoint AJAX per validar si usuari/correu existeixen.
func (a *App) CheckAvailability(w http.ResponseWriter, r *http.Request) {goCover_33ba7a78e32c__137[0] = 11 ; goCover_33ba7a78e32c__137[1] = goCover_33ba7a78e32c_P ; goCover_33ba7a78e32c__137[2] = 137 ; goCover_33ba7a78e32c__137[3]++;
	if r.Method != http.MethodPost {goCover_33ba7a78e32c__137[8]++;
		http.Error(w, "Mètode no permès", http.StatusMethodNotAllowed)
		return
	}
	goCover_33ba7a78e32c__137[4]++;if !validateCSRF(r, r.FormValue("csrf_token")) && !validateCSRF(r, r.Header.Get("X-CSRF-Token")) {goCover_33ba7a78e32c__137[9]++;
		http.Error(w, "Error: accés no autoritzat", http.StatusForbidden)
		return
	}

	goCover_33ba7a78e32c__137[5]++;username := r.FormValue("username")
	email := r.FormValue("email")

	resp := AvailabilityResponse{}

	if username != "" {goCover_33ba7a78e32c__137[10]++;
		if exists, err := a.DB.ExistsUserByUsername(username); err == nil {goCover_33ba7a78e32c__137[11]++;
			resp.UsernameTaken = exists
		}
	}
	goCover_33ba7a78e32c__137[6]++;if email != "" {goCover_33ba7a78e32c__137[12]++;
		if exists, err := a.DB.ExistsUserByEmail(email); err == nil {goCover_33ba7a78e32c__137[13]++;
			resp.EmailTaken = exists
		}
	}

	goCover_33ba7a78e32c__137[7]++;w.Header().Set("Content-Type", "application/json")
	_ = json.NewEncoder(w).Encode(resp)
}
