//line /home/marc/codi/CercaGenealogica3/db/motor.go:1:1
package db

import (
	"database/sql"
	"fmt"
	"os"
	"strings"
)

type DB interface {
	Connect() error
	Close()
	Exec(query string, args ...interface{}) (int64, error)
	Query(query string, args ...interface{}) ([]map[string]interface{}, error)
	InsertUser(user *User) error
	SaveActivationToken(email, token string) error
	GetUserByEmail(email string) (*User, error)
	ExistsUserByUsername(username string) (bool, error)
	ExistsUserByEmail(email string) (bool, error)
	ActivateUser(token string) error
	AuthenticateUser(usernameOrEmail, password string) (*User, error)
	SaveSession(sessionID string, userID int, expiry string) error
	GetSessionUser(sessionID string) (*User, error)
	DeleteSession(sessionID string) error
	CreatePasswordReset(email, token, expiry, lang string) (bool, error)
	GetPasswordReset(token string) (*PasswordReset, error)
	MarkPasswordResetUsed(id int) error
	UpdateUserPassword(userID int, passwordHash []byte) error
	CreatePrivacyDefaults(userID int) error
	GetPrivacySettings(userID int) (*PrivacySettings, error)
	SavePrivacySettings(userID int, p *PrivacySettings) error
	UpdateUserProfile(u *User) error
	UpdateUserEmail(userID int, newEmail string) error
	CreateEmailChange(userID int, newEmail, tokenConfirm, expConfirm, tokenRevert, expRevert, lang string) error
	ConfirmEmailChange(token string) (*EmailChange, error)
	RevertEmailChange(token string) (*EmailChange, error)
	// Policies
	UserHasAnyPolicy(userID int, policies []string) (bool, error)
	EnsureDefaultPolicies() error
	// Arxius CRUD
	ListArxius(filter ArxiuFilter) ([]ArxiuWithCount, error)
	GetArxiu(id int) (*Arxiu, error)
	CreateArxiu(a *Arxiu) (int, error)
	UpdateArxiu(a *Arxiu) error
	DeleteArxiu(id int) error
	ListArxiuLlibres(arxiuID int) ([]ArxiuLlibreDetail, error)
	AddArxiuLlibre(arxiuID, llibreID int, signatura, urlOverride string) error
	UpdateArxiuLlibre(arxiuID, llibreID int, signatura, urlOverride string) error
	DeleteArxiuLlibre(arxiuID, llibreID int) error
	SearchLlibresSimple(q string, limit int) ([]LlibreSimple, error)
	ListLlibres(filter LlibreFilter) ([]LlibreRow, error)
	GetLlibre(id int) (*Llibre, error)
	CreateLlibre(l *Llibre) (int, error)
	UpdateLlibre(l *Llibre) error
	ListLlibrePagines(llibreID int) ([]LlibrePagina, error)
	SaveLlibrePagina(p *LlibrePagina) (int, error)
	RecalcLlibrePagines(llibreID, total int) error

	// Paisos
	ListPaisos() ([]Pais, error)
	GetPais(id int) (*Pais, error)
	CreatePais(p *Pais) (int, error)
	UpdatePais(p *Pais) error

	// Nivells administratius
	ListNivells(f NivellAdminFilter) ([]NivellAdministratiu, error)
	GetNivell(id int) (*NivellAdministratiu, error)
	CreateNivell(n *NivellAdministratiu) (int, error)
	UpdateNivell(n *NivellAdministratiu) error

	// Municipis
	ListMunicipis(f MunicipiFilter) ([]MunicipiRow, error)
	GetMunicipi(id int) (*Municipi, error)
	CreateMunicipi(m *Municipi) (int, error)
	UpdateMunicipi(m *Municipi) error
	ListCodisPostals(municipiID int) ([]CodiPostal, error)
	SaveCodiPostal(cp *CodiPostal) (int, error)

	// Entitats eclesiàstiques
	ListArquebisbats(f ArquebisbatFilter) ([]ArquebisbatRow, error)
	GetArquebisbat(id int) (*Arquebisbat, error)
	CreateArquebisbat(ae *Arquebisbat) (int, error)
	UpdateArquebisbat(ae *Arquebisbat) error
	ListArquebisbatMunicipis(munID int) ([]ArquebisbatMunicipi, error)
	SaveArquebisbatMunicipi(am *ArquebisbatMunicipi) (int, error)
}

// Tipus comú d'usuari al paquet `db`
type User struct {
	ID            int
	Usuari        string
	Name          string
	Surname       string
	Email         string
	Password      []byte
	DataNaixament string
	Active        bool
	CreatedAt     string
	Pais          string
	Estat         string
	Provincia     string
	Poblacio      string
	CodiPostal    string
	Address       string
	Employment    string
	Profession    string
	Phone         string
	PreferredLang string
	SpokenLangs   string
}

type PasswordReset struct {
	ID     int
	UserID int
	Email  string
	Lang   string
}

type PrivacySettings struct {
	UserID                  int
	NomVisibility           string
	CognomsVisibility       string
	EmailVisibility         string
	BirthVisibility         string
	PaisVisibility          string
	EstatVisibility         string
	ProvinciaVisibility     string
	PoblacioVisibility      string
	PostalVisibility        string
	AddressVisibility       string
	EmploymentVisibility    string
	ProfessionVisibility    string
	PhoneVisibility         string
	PreferredLangVisibility string
	SpokenLangsVisibility   string
	ShowActivity            bool
	ProfilePublic           bool
	NotifyEmail             bool
	AllowContact            bool
}

type Pais struct {
	ID          int
	CodiISO2    string
	CodiISO3    string
	CodiPaisNum string
}

type NivellAdministratiu struct {
	ID          int
	PaisID      int
	Nivel       int
	NomNivell   string
	TipusNivell string
	CodiOficial string
	Altres      string
	ParentID    sql.NullInt64
	ParentNom   sql.NullString
	AnyInici    sql.NullInt64
	AnyFi       sql.NullInt64
	Estat       string
}

type NivellAdminFilter struct {
	PaisID int
	Nivel  int
	Estat  string
}

type Municipi struct {
	ID                    int
	Nom                   string
	MunicipiID            sql.NullInt64
	Tipus                 string
	NivellAdministratiuID [7]sql.NullInt64
	CodiPostal            string
	Latitud               sql.NullFloat64
	Longitud              sql.NullFloat64
	What3Words            string
	Web                   string
	Wikipedia             string
	Altres                string
	Estat                 string
}

type MunicipiRow struct {
	ID         int
	Nom        string
	Tipus      string
	Estat      string
	CodiPostal string
	PaisNom    sql.NullString
	ProvNom    sql.NullString
	Comarca    sql.NullString
}

type MunicipiFilter struct {
	Text   string
	Estat  string
	PaisID int
}

type CodiPostal struct {
	ID         int
	MunicipiID int
	CodiPostal string
	Zona       string
	Desde      sql.NullString
	Fins       sql.NullString
}

type Arquebisbat struct {
	ID           int
	Nom          string
	TipusEntitat string
	PaisID       sql.NullInt64
	Nivell       sql.NullInt64
	ParentID     sql.NullInt64
	AnyInici     sql.NullInt64
	AnyFi        sql.NullInt64
	Web          string
	WebArxiu     string
	WebWikipedia string
	Territori    string
	Observacions string
}

type ArquebisbatRow struct {
	ID           int
	Nom          string
	TipusEntitat string
	PaisNom      sql.NullString
	Nivell       sql.NullInt64
	ParentNom    sql.NullString
	AnyInici     sql.NullInt64
	AnyFi        sql.NullInt64
}

type ArquebisbatFilter struct {
	Text   string
	PaisID int
}

type ArquebisbatMunicipi struct {
	ID            int
	MunicipiID    int
	ArquebisbatID int
	AnyInici      sql.NullInt64
	AnyFi         sql.NullInt64
	Motiu         string
	Font          string
	NomEntitat    string
}

type EmailChange struct {
	ID           int
	UserID       int
	OldEmail     string
	NewEmail     string
	TokenConfirm string
	ExpConfirm   string
	TokenRevert  string
	ExpRevert    string
	Lang         string
	Confirmed    bool
	Reverted     bool
}

// Arxius
type Arxiu struct {
	ID                    int
	Nom                   string
	Tipus                 string
	MunicipiID            sql.NullInt64
	EntitatEclesiasticaID sql.NullInt64
	Adreca                string
	Ubicacio              string
	Web                   string
	Acces                 string
	Notes                 string
}

type ArxiuFilter struct {
	Text      string
	Tipus     string
	Acces     string
	EntitatID int
	PaisID    int
	Limit     int
	Offset    int
}

type ArxiuWithCount struct {
	Arxiu
	MunicipiNom sql.NullString
	EntitatNom  sql.NullString
	Llibres     int
}

type ArxiuLlibreDetail struct {
	ArxiuID     int
	LlibreID    int
	Titol       string
	NomEsglesia string
	Cronologia  string
	Municipi    sql.NullString
	Signatura   sql.NullString
	URLOverride sql.NullString
}

type LlibreSimple struct {
	ID          int
	Titol       string
	NomEsglesia string
	Cronologia  string
	Municipi    sql.NullString
}

type Llibre struct {
	ID                int
	ArquebisbatID     int
	MunicipiID        int
	NomEsglesia       string
	CodiDigital       string
	CodiFisic         string
	Titol             string
	Cronologia        string
	Volum             string
	Abat              string
	Contingut         string
	Llengua           string
	Requeriments      string
	UnitatCatalogacio string
	UnitatInstalacio  string
	Pagines           sql.NullInt64
	URLBase           string
	URLImatgePrefix   string
	Pagina            string
}

type LlibreRow struct {
	Llibre
	ArquebisbatNom sql.NullString
	MunicipiNom    sql.NullString
}

type LlibreFilter struct {
	Text          string
	ArquebisbatID int
	MunicipiID    int
}

type LlibrePagina struct {
	ID        int
	LlibreID  int
	NumPagina int
	Estat     string
	IndexedAt sql.NullString
	IndexedBy sql.NullInt64
	Notes     string
}

// Funció principal per obtenir una connexió i recrear BD si cal
func NewDB(config map[string]string) (DB, error) {goCover_4bc4be4c3247__3[0] = 11 ; goCover_4bc4be4c3247__3[1] = goCover_4bc4be4c3247_P ; goCover_4bc4be4c3247__3[2] = 3 ; goCover_4bc4be4c3247__3[3]++;
	var dbInstance DB
	engine := config["DB_ENGINE"]

	switch engine {
	case "sqlite":goCover_4bc4be4c3247__3[7]++;
		dbInstance = &SQLite{Path: config["DB_PATH"]}
	case "postgres":goCover_4bc4be4c3247__3[8]++;
		dbInstance = &PostgreSQL{
			Host:   config["DB_HOST"],
			Port:   config["DB_PORT"],
			User:   config["DB_USR"],
			Pass:   config["DB_PASS"],
			DBName: config["DB_NAME"],
		}
	case "mysql":goCover_4bc4be4c3247__3[9]++;
		dbInstance = &MySQL{
			Host:   config["DB_HOST"],
			Port:   config["DB_PORT"],
			User:   config["DB_USR"],
			Pass:   config["DB_PASS"],
			DBName: config["DB_NAME"],
		}
	default:goCover_4bc4be4c3247__3[10]++;
		return nil, fmt.Errorf("motor de BD desconegut: %s", engine)
	}

	// Connectem primer
	goCover_4bc4be4c3247__3[4]++;if err := dbInstance.Connect(); err != nil {goCover_4bc4be4c3247__3[11]++;
		return nil, err
	}

	// Si cal, recrearem la BD
	goCover_4bc4be4c3247__3[5]++;if config["RECREADB"] == "true" {goCover_4bc4be4c3247__3[12]++;
		sqlFile := getSQLFilePath(engine)
		if err := CreateDatabaseFromSQL(sqlFile, engine, dbInstance); err != nil {goCover_4bc4be4c3247__3[13]++;
			return nil, fmt.Errorf("error recreant BD amb %s: %v", engine, err)
		}
	}

	goCover_4bc4be4c3247__3[6]++;return dbInstance, nil
}

// Obtenir el path del fitxer SQL segons el motor
func getSQLFilePath(engine string) string {goCover_4bc4be4c3247__4[0] = 5 ; goCover_4bc4be4c3247__4[1] = goCover_4bc4be4c3247_P ; goCover_4bc4be4c3247__4[2] = 4 ; goCover_4bc4be4c3247__4[3]++;
	switch engine {
	case "sqlite":goCover_4bc4be4c3247__4[4]++;
		return "db/SQLite.sql"
	case "postgres":goCover_4bc4be4c3247__4[5]++;
		return "db/PostgreSQL.sql"
	case "mysql":goCover_4bc4be4c3247__4[6]++;
		return "db/MySQL.sql"
	default:goCover_4bc4be4c3247__4[7]++;
		return ""
	}
}

// Funció genèrica per executar totes les sentències SQL d'un fitxer
// Funció genèrica per executar totes les sentències SQL d'un fitxer
func CreateDatabaseFromSQL(sqlFile, engine string, db DB) error {goCover_4bc4be4c3247__5[0] = 29 ; goCover_4bc4be4c3247__5[1] = goCover_4bc4be4c3247_P ; goCover_4bc4be4c3247__5[2] = 5 ; goCover_4bc4be4c3247__5[3]++;
	logInfof("Recreant BD des de: %s", sqlFile)
	data, err := os.ReadFile(sqlFile)
	if err != nil {goCover_4bc4be4c3247__5[12]++;
		return fmt.Errorf("no s'ha pogut llegir el fitxer SQL: %w", err)
	}

	goCover_4bc4be4c3247__5[4]++;raw := string(data)

	// 1) Elimina línies de comentari i línies buides,
	//    però conserva el SQL que vingui després en altres línies
	var b strings.Builder
	for _, line := range strings.Split(raw, "\n") {goCover_4bc4be4c3247__5[13]++;
		trimmed := strings.TrimSpace(line)
		if strings.HasPrefix(trimmed, "--") || trimmed == "" {goCover_4bc4be4c3247__5[15]++;
			continue
		}
		goCover_4bc4be4c3247__5[14]++;b.WriteString(line)
		b.WriteByte('\n')
	}
	goCover_4bc4be4c3247__5[5]++;cleanSQL := b.String()

	// 2) Separa per ';' i neteja espais. (Semicolons al final del statement)
	parts := strings.Split(cleanSQL, ";")

	// 3) Escollir com començar la transacció segons el motor
	beginStmt := "BEGIN"
	switch engine {
	case "sqlite":goCover_4bc4be4c3247__5[16]++;
		beginStmt = "BEGIN IMMEDIATE"
	case "postgres", "mysql":goCover_4bc4be4c3247__5[17]++;
		beginStmt = "BEGIN"
	default:goCover_4bc4be4c3247__5[18]++;
		beginStmt = "BEGIN"
	}

	goCover_4bc4be4c3247__5[6]++;if _, err := db.Exec(beginStmt); err != nil {goCover_4bc4be4c3247__5[19]++;
		return fmt.Errorf("no s’ha pogut començar transacció: %w", err)
	}
	goCover_4bc4be4c3247__5[7]++;defer func() {goCover_4bc4be4c3247__5[20]++;
		// en cas d’error, el caller retornarà; aquí fem un ROLLBACK best-effort
		_, _ = db.Exec("ROLLBACK")
	}()

	// 4) Activar FKs només per SQLite (PRAGMA és específic de SQLite)
	goCover_4bc4be4c3247__5[8]++;if engine == "sqlite" {goCover_4bc4be4c3247__5[21]++;
		if _, err := db.Exec("PRAGMA foreign_keys = ON"); err != nil {goCover_4bc4be4c3247__5[22]++;
			return fmt.Errorf("error activant foreign_keys: %w", err)
		}
	}

	// 5) Executa cada statement
	goCover_4bc4be4c3247__5[9]++;for _, stmt := range parts {goCover_4bc4be4c3247__5[23]++;
		q := strings.TrimSpace(stmt)
		if q == "" {goCover_4bc4be4c3247__5[26]++;
			continue
		}
		// Evita BEGIN/COMMIT del fitxer, si n’hi hagués
		goCover_4bc4be4c3247__5[24]++;low := strings.ToLower(q)
		if low == "begin" || low == "commit" || strings.HasPrefix(low, "begin ") || strings.HasPrefix(low, "commit ") {goCover_4bc4be4c3247__5[27]++;
			continue
		}

		goCover_4bc4be4c3247__5[25]++;if _, err := db.Exec(q); err != nil {goCover_4bc4be4c3247__5[28]++;
			// Mostra un tros de l’SQL per facilitar el debug
			snip := q
			if len(snip) > 120 {goCover_4bc4be4c3247__5[30]++;
				snip = snip[:120] + " ..."
			}
			goCover_4bc4be4c3247__5[29]++;return fmt.Errorf("error executant '%s': %w", snip, err)
		}
	}

	// 6) Commit final
	goCover_4bc4be4c3247__5[10]++;if _, err := db.Exec("COMMIT"); err != nil {goCover_4bc4be4c3247__5[31]++;
		return fmt.Errorf("error fent COMMIT: %w", err)
	}

	goCover_4bc4be4c3247__5[11]++;logInfof("BD recreada correctament")
	return nil
}
